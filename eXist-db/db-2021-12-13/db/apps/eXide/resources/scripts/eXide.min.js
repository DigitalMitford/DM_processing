define("eXide/mode/xquery_highlight_rules",function(c,a){var b=c("ace/lib/oop"),e=c("ace/lib/lang"),f=c("ace/mode/text_highlight_rules").TextHighlightRules,d=function(){var a=e.arrayToMap("return for let where order by declare function variable xquery version option namespace import module switch default map if then else as and or typeswitch case ascending descending empty in".split(" "));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},
{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"comment",regex:"\\%\\w[\\w+_\\-:]+\\b"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},
{token:"lparen",regex:"[[({]"},{token:"rparen",regex:"[\\])}]"},{token:function(b){return a[b]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",
next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};b.inherits(d,f);a.XQueryHighlightRules=d});
define("eXide/mode/behaviour/xquery",function(c,a){var b=c("ace/lib/oop"),e=c("ace/mode/behaviour").Behaviour,f=c("ace/mode/behaviour/cstyle").CstyleBehaviour,d=function(a){this.inherit(f,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(a,b,d,c,g){return"\n"==g&&(b=d.getCursorPosition(),"</"==c.doc.getLine(b.row).substring(b.column,b.column+2))?(a=this.$getIndent(c.doc.getLine(b.row))+c.getTabString(),c=this.$getIndent(c.doc.getLine(b.row)),{text:"\n"+a+
"\n"+c,selection:[1,a.length,1,a.length]}):!1});this.add("comments","insertion",function(a,b,d,c,g){a=d.getCursorPosition();c=c.doc.getLine(a.row);if("\n"==g&&c.match(/^[\(\s]:/))return{text:"\n : ",selection:[1,3,1,3]};if(":"==g&&"("==c.substring(a.column-1,1))return{text:":  :",selection:[2,2]}});this.add("slash","insertion",function(b,d,c,e,n){"/"==n&&(b=c.getCursorPosition(),d=e.doc.getLine(b.row),0<b.column&&"<"==d.charAt(b.column-1)&&(d=d.substring(0,b.column)+"/"+d.substring(b.column+1,d.length),
c=e.doc.getAllLines(),c[b.row]=d,a.exec("closeTag",c.join(e.doc.getNewLineCharacter()),b.row)));return!1})};b.inherits(d,e);a.XQueryBehaviour=d});
define("eXide/mode/xquery",function(c,a){var b=c("ace/lib/oop"),e=c("ace/mode/text").Mode,f=c("lib/XQueryLexer").XQueryLexer;c("ace/tokenizer");var d=c("eXide/mode/behaviour/xquery").XQueryBehaviour,g=c("ace/mode/folding/cstyle").FoldMode,l=c("ace/range").Range,h=function(a){this.$tokenizer=new f;this.$behaviour=new d(a);this.foldingRules=new g};b.inherits(h,e);(function(){this.getNextLineIndent=function(a,b,d){a=this.$getIndent(b);b.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(a+=d);return a};
this.checkOutdent=function(a,b,d){return!/^\s+$/.test(b)?!1:/^\s*[\}\)]/.test(d)};this.autoOutdent=function(a,b,d){a=b.getLine(d).match(/^(\s*[\}\)])/);if(!a)return 0;var a=a[1].length,c=b.findMatchingBracket({row:d,column:a});if(!c||c.row==d)return 0;c=this.$getIndent(b.getLine(c.row));b.replace(new l(d,0,d,a-1),c)};this.$getIndent=function(a){return(a=a.match(/^(\s+)/))?a[1]:""};this.toggleCommentLines=function(a,b,d,c){for(var g=!0,e=/^\s*\(:(.*):\)/,a=d;a<=c;a++)if(!e.test(b.getLine(a))){g=!1;
break}for(var f=new l(0,0,0,0),a=d;a<=c;a++)d=b.getLine(a),f.start.row=a,f.end.row=a,f.end.column=d.length,b.replace(f,g?d.match(e)[1]:"(:"+d+":)")}}).call(h.prototype);a.Mode=h});
define("eXide/mode/behaviour/xml",function(c,a){function b(a,b){var d=!0,c=a.type.split(".");b.split(".").forEach(function(a){if(-1==c.indexOf(a))return d=!1});return d}var e=c("ace/lib/oop"),f=c("ace/mode/behaviour").Behaviour,d=c("ace/mode/behaviour/cstyle").CstyleBehaviour,g=c("ace/token_iterator").TokenIterator,l=function(a){this.inherit(d,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(a,b,d,c,g){return"\n"==g&&(b=d.getCursorPosition(),"</"==c.doc.getLine(b.row).substring(b.column,
b.column+2))?(a=this.$getIndent(c.doc.getLine(b.row))+c.getTabString(),c=this.$getIndent(c.doc.getLine(b.row)),{text:"\n"+a+"\n"+c,selection:[1,a.length,1,a.length]}):!1});this.add("slash","insertion",function(b,d,c,g,e){"/"==e&&(b=c.getCursorPosition(),d=g.doc.getLine(b.row),0<b.column&&"<"==d.charAt(b.column-1)&&(d=d.substring(0,b.column)+"/"+d.substring(b.column),c=g.doc.getAllLines(),c[b.row]=d,a.exec("closeTag",c.join(g.doc.getNewLineCharacter()),b.row)));return!1});this.add("autoclosing","insertion",
function(a,d,c,e,f){if(">"==f){a=c.getCursorPosition();c=new g(e,a.row,a.column);e=c.getCurrentToken();d=!1;if(!e||!b(e,"meta.tag")&&(!b(e,"text")||!e.value.match("/"))){do e=c.stepBackward();while(e&&(b(e,"string")||b(e,"keyword.operator")||b(e,"entity.attribute-name")||b(e,"text")))}else d=!0;if(e&&b(e,"meta.tag-name")&&!c.stepBackward().value.match("/"))return c=e.value,d&&(c=c.substring(0,a.column-e.start)),{text:"></"+c+">",selection:[1,1]}}})};e.inherits(l,f);a.XMLBehaviour=l});
define("eXide/mode/xml",function(c,a){var b=c("ace/lib/oop"),e=c("ace/mode/xml").Mode,f=c("ace/tokenizer").Tokenizer,d=c("ace/mode/xml_highlight_rules").XmlHighlightRules,g=c("ace/mode/folding/xml").FoldMode,l=c("eXide/mode/behaviour/xml").XMLBehaviour,h=c("ace/range").Range,j=function(a){this.$tokenizer=new f((new d).getRules());this.$behaviour=new l(a);this.foldingRules=new g};b.inherits(j,e);(function(){this.toggleCommentLines=function(a,b,d,c){for(var g=!0,e=/^\s*<\!--(.*)--\>/,a=d;a<=c;a++)if(!e.test(b.getLine(a))){g=
!1;break}for(var f=new h(0,0,0,0),a=d;a<=c;a++)d=b.getLine(a),f.start.row=a,f.end.row=a,f.end.column=d.length,b.replace(f,g?d.match(e)[1]:"<\!--"+d+"--\>")}}).call(j.prototype);a.Mode=j});
define("eXide/mode/html",function(c,a){var b=c("ace/lib/oop"),e=c("ace/mode/html").Mode,f=c("ace/tokenizer").Tokenizer,d=c("ace/mode/html_highlight_rules").HtmlHighlightRules,g=c("ace/mode/folding/html").FoldMode,l=c("eXide/mode/behaviour/xml").XMLBehaviour,h=c("ace/range").Range,j=c("ace/mode/javascript").Mode,m=c("ace/mode/css").Mode,n=function(a){var b=new d;this.$tokenizer=new f(b.getRules());this.$behaviour=new l(a);this.foldingRules=new g;this.$embeds=b.getEmbeds();this.createModeDelegates({"js-":j,
"css-":m})};b.inherits(n,e);(function(){this.toggleCommentLines=function(a,b,d,c){for(var g=!0,e=/^\s*<\!--(.*)--\>/,a=d;a<=c;a++)if(!e.test(b.getLine(a))){g=!1;break}for(var f=new h(0,0,0,0),a=d;a<=c;a++)d=b.getLine(a),f.start.row=a,f.end.row=a,f.end.column=d.length,b.replace(f,g?d.match(e)[1]:"<\!--"+d+"--\>")}}).call(n.prototype);a.Mode=n});var eXide=eXide||{};eXide.namespace=function(c){var c=c.split("."),a=eXide,b;"eXide"==c[0]&&(c=c.slice(1));for(b=0;b<c.length;b++)"undefined"==typeof a[c[b]]&&(a[c[b]]={}),a=a[c[b]];return a};eXide.namespace("eXide.util");
eXide.util=function(){var c={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};$(document).ready(function(){$.pnotify.defaults.history=!1;$.pnotify.defaults.styling="jqueryui"});return{supportsHtml5Storage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},supportsFullScreen:function(){return document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen?!0:!1},requestFullScreen:function(a){if(document.fullScreen||document.webkitIsFullScreen||
document.mozFullScreen){var b=document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen;b.call(document)}else(b=a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen)&&b.call(a,!0)},normalizePath:function(a){if(!a)return a;for(var a=a.replace(/^xmldb:exist:\/\//,""),b=[],a=a.split("/"),c=a.length,f=0;f<c;f++)".."==a[f]?b.pop():b.push(a[f]);return b.join("/")},parseSignature:function(a){var b=a.indexOf("(");if(-1<b){var c=a.substring(0,b+1),a=a.substring(b);
if(a=a.match(/\$[^\s,\)]+/g))for(b=0;b<a.length;b++)0<b&&(c+=", "),c+="${"+(b+1)+":\\$"+a[b].substring(1)+"}";return c+")"}return a},message:function(a){$.pnotify({text:a,shadow:!0,hide:!0,closer:!0,opacity:0.65,addclass:"stack-bottomright custom",stack:c})},success:function(a){$.pnotify({text:a,shadow:!0,type:"success",hide:!0,closer:!0,opacity:0.65,addclass:"stack-bottomright custom",stack:c})},error:function(a,b){var e={text:a,type:"error",shadow:!0,hide:!0,addclass:"stack-bottomright custom",
stack:c};b&&(e.title=b);$.pnotify(e)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var c,a=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<span id="eXide-dialog-message-icon" class="fa fa-4x fa-info-circle"></span>\t<div id="eXide-dialog-message-body"></div></div>');c=$("#eXide-dialog-message");c.dialog({appendTo:"#layout-container",modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<span id="eXide-dialog-message-icon" class="fa fa-4x fa-info-circle"></span>\t<div id="eXide-dialog-input-body"></div></div>');inputDialog=
$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");null!=a&&a.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(a,e){null==e&&(e="");c.dialog("option","title",a);$("#eXide-dialog-message-body").html(e);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");c.dialog("open")},warning:function(a,e){null==e&&(e="");c.dialog("option","title",a);$("#eXide-dialog-message-body").html(e);
$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");c.dialog("open")},input:function(b,c,f){a=f;inputDialog.dialog("option","title",b);$("#eXide-dialog-input-body").html(c);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var c={xml:["text/xml","application/xml","application/xhtml+xml","application/atom+xml","application/xslt+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"],text:["text/text"],less:["application/less"],tmsnippet:["application/tmsnippet"],json:["application/json"],markdown:["text/x-markdown"]};return{getMime:function(a){var b=a.indexOf(";");-1<b&&(a=a.substring(0,b));return a},getLangFromMime:function(a){for(var b in c)for(var e=
c[b],f=0;f<e.length;f++)if(a==e[f])return b;return"xquery"},getMimeFromLang:function(a){return(a=c[a])?a[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");eXide.util.oop.inherit=function(){var c=function(){};return function(a,b){c.prototype=b.prototype;a.prototype=new c;a.super_=b.prototype;a.prototype.constructor=a}}();eXide.util.oop.extend=function(){return function(c,a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])}}();
(function(c){c.log=function(){window.console&&window.console.log&&Function.prototype.bind.call(console.log,console).apply(console,arguments)};c.fn.log=function(){c.log(this);return this}})(jQuery);eXide.namespace("eXide.edit.History");eXide.edit.History=function(){Constr=function(){this.history=[]};Constr.prototype.push=function(c,a){if(0<this.history.length){var b=this.history[this.history.length-1];if(b.path===c&&b.line===a)return}this.history.push({path:c,line:a});50<this.history.length&&this.history.shift()};Constr.prototype.pop=function(){return 0===this.history.length?null:this.history.pop()};return Constr}();eXide.namespace("eXide.util.Popup");
eXide.util.Popup=function(){function c(){$(g).find(".title span").text(p);if(0==p.length)h.find("tr").css("display","");else{h.find("tr").removeClass("selection").css("display","none");var b=RegExp(p,"i");h.find("tr").each(function(){var a=$(this).find("td:first .label").text();b.test(a)&&$(this).css("display","")})}a(h.find("tr:visible").first())}function a(a){if(0!=a.length){n.removeClass("selection");a.addClass("selection");n=a;var a=a[0],b=l[0];a.offsetTop<b.scrollTop?b.scrollTop=a.offsetTop-
3:a.offsetTop+a.offsetHeight>b.scrollTop+b.clientHeight&&(b.scrollTop=a.offsetTop+a.offsetHeight-b.clientHeight+3);var d=n.find(".tooltip");0<d.length?e(!0,function(){m.empty().html(d[0].innerHTML)}):e(!1)}}function b(a,b){return a.label==b.label?0:a.label>b.label?1:-1}function e(a,b){var d=0<m.width();m.empty();a?d?m.html(b):m.removeClass("hide").animate({width:320},300,function(){m.html(b)}):d&&m.animate({width:0},300,function(){m.addClass("hide")})}function f(){g.css("display","none");m.css("width",
"0").empty().addClass("hide");keydown=!1;p="";$(g).find(".title span").text(p);j.focus()}var d=[],g,l,h,j,m=null,n=null,q=function(){},p="";return{init:function(b,e){g=$(b);j=e;var r=$("<div class='title'><a href='#'>[X]</a><span>Type to filter</span></div>").appendTo(g);l=$("<div class='items'><table></table></div>").appendTo(g);h=l.find("table");m=$("<div class='tooltips hide'></div>").appendTo(g);r.find("a").click(function(a){a.preventDefault();f()});$(g).on("keydown",function(b){keydown=!0;40==
b.which?(b.preventDefault(),b=h.find("tr").index(n),b=n.nextAll(":visible").first(),0<b.length&&a(b)):38==b.which?(b.preventDefault(),b=n.prevAll(":visible").first(),0<b.length&&a(b)):13==b.which?(b.preventDefault(),b=h.find("tr").index(n),f(),q.call(null,d[b])):27==b.which?(b.preventDefault(),f(),q.call(null,null)):8==b.which&&(b.preventDefault(),0<p.length&&(p=p.substring(0,p.length-1),c()))});$(g).on("keypress",function(a){if(keydown)switch(a=0==a.which?a.keyCode:a.which,a){case 40:case 38:case 13:case 27:case 8:break;
default:p+=String.fromCharCode(a),c()}})},show:function(c,e){q=e;d=c;p="";h.empty();d.sort(b);for(var f=0;f<d.length;f++){var l=document.createElement("tr");0==f&&(l.className="selection",n=$(l));var j;if(d[f].label instanceof Array)for(var i=0;i<d[f].label.length;i++){j=document.createElement("td");var o=document.createElement("span");o.className="label";o.appendChild(document.createTextNode(d[f].label[i]));j.appendChild(o);l.appendChild(j)}else j=document.createElement("td"),o=document.createElement("span"),
o.className="label",o.appendChild(document.createTextNode(d[f].label)),j.appendChild(o),l.appendChild(j);d[f].tooltip&&(i=document.createElement("span"),i.className="tooltip",i.innerHTML=d[f].tooltip,j.appendChild(i));h.append(l);$(l).click(function(){n.removeClass("selection");$(this).addClass("selection");a($(this))});$(l).dblclick(function(){var a=h.find("tr").index(n);g.css("display","none");m&&m.css("display","none");q.call(null,d[a])})}a(n);g.fadeIn().focus()},position:function(a){g.css({visibility:"hidden",
display:"block"});g.css({left:a.pageX,top:a.pageY+15});var b=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),d=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight),c=g[0].getBoundingClientRect(),e=c.right-b,f=c.bottom-d;0<e&&(c.right-c.left>b&&(g[0].style.width=b-5+"px",e-=c.right-c.left-b),g.css("left",(left=a.pageX-e)+"px"));0<f&&(b=c.bottom-15-c.top,0<c.top-b?(f=b+15,below=!1):b>d&&(g.height(d-5+"px"),f-=b-d),
g.css("top",(top=a.pageY-f)+"px"));g.css({visibility:"visible",display:"none"})}}}();eXide.namespace("eXide.events.Sender");
eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(c,a,b){"function"==typeof a&&(b=a,a=null);this.events=this.events||{};var e=this.events[c];e||(e=[],this.events[c]=e);e.push({obj:a,callback:b})},$triggerEvent:function(c,a){this.events=this.events||{};var b=this.events[c];if(b)for(var e=0;e<b.length;e++)b[e].callback.apply(b[e].obj,a)},removeEventListener:function(c,a,b){"function"==typeof a&&(b=a,a=null);var e=(this.events||{})[c];if(e){for(var f=0;f<
e.length&&!(e[f].obj===a&&e[f].callback===b);f++);f<e.length&&this.events[c].splice(f,1)}}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function c(a){if(a)return{win:a[0],mac:a[1],sender:"editor"}}var a=require("ace/lib/useragent"),b=require("ace/snippets").snippetManager,e={};return{init:function(f){var d=f.editor.commands;$.ajax({url:"keybindings.js",dataType:"json",async:!1,success:function(g){function l(a){return function(){f.selectTab(a-1)}}d.addCommand({name:"gotoLine",bindKey:c(g.gotoLine),exec:function(){f.gotoLine()}});d.addCommand({name:"historyBack",bindKey:c(g.historyBack),exec:function(){f.historyBack()}});
d.addCommand({name:"fold",bindKey:c(g.fold),exec:function(a){a.session.toggleFold(!1)},readOnly:!0});d.addCommand({name:"selectMoreBefore",exec:function(a){a.selectMore(-1)},bindKey:{win:"Ctrl-Alt-Left",mac:"Ctrl-Alt-Command-Left"},readOnly:!0});d.addCommand({name:"selectMoreAfter",exec:function(a){a.selectMore(1)},bindKey:{win:"Ctrl-Alt-Right",mac:"Ctrl-Alt-Command-Right"},readOnly:!0});d.addCommand({name:"unfold",bindKey:c(g.unfold),exec:function(a){a.session.toggleFold(!0)},readOnly:!0});d.addCommand({name:"saveDocument",
bindKey:c(g.saveDocument),exec:function(){eXide.app.saveDocument()}});d.addCommand({name:"runQuery",bindKey:c(g.runQuery),exec:function(){eXide.app.runQuery()}});d.addCommand({name:"runQueryOrApp",bindKey:c(g.runQueryOrApp),exec:function(){eXide.app.runAppOrQuery()}});d.addCommand({name:"openDocument",bindKey:c(g.openDocument),exec:function(){eXide.app.openDocument()}});d.addCommand({name:"newDocumentFromTemplate",bindKey:c(g.newDocumentFromTemplate),exec:function(){eXide.app.newDocumentFromTemplate()}});
d.addCommand({name:"closeDocument",bindKey:c(g.closeDocument),exec:function(){eXide.app.closeDocument()}});d.addCommand({name:"closeAll",bindKey:c(g.closeAll),exec:function(){eXide.app.closeAll()}});d.addCommand({name:"autocomplete",bindKey:c(g.autocomplete),exec:function(){f.autocomplete()}});d.addCommand({name:"nextTab",bindKey:c(g.nextTab),exec:function(){f.nextTab()}});d.addCommand({name:"previousTab",bindKey:c(g.previousTab),exec:function(){f.previousTab()}});d.addCommand({name:"xquery-format",
bindKey:c(g.xqueryFormat),exec:function(){f.exec("format")}});d.addCommand({name:"functionDoc",bindKey:c(g.functionDoc),exec:function(){f.exec("showFunctionDoc")}});d.addCommand({name:"gotoDefinition",bindKey:c(g.gotoDefinition),exec:function(){f.exec("gotoDefinition")}});d.addCommand({name:"gotoSymbol",hint:"Goto symbol",bindKey:c(g.gotoSymbol),exec:function(){f.exec("gotoSymbol")}});d.addCommand({name:"searchReplace",bindKey:c(g.searchReplace),exec:function(){f.search.open()}});d.addCommand({name:"findModule",
bindKey:c(g.findModule),exec:function(){var a=f.getActiveDocument();eXide.find.Modules.select(a.syntax)}});d.addCommand({name:"escape",bindKey:c(g.escape),exec:function(a){f.getActiveDocument().template=null;a.clearSelection()}});d.addCommand({name:"dbManager",bindKey:c(g.dbManager),exec:function(){eXide.app.manage()}});d.addCommand({name:"toggleComment",bindKey:c(g.toggleComment),exec:function(a){a.toggleCommentLines()}});d.addCommand({name:"synchronize",bindKey:c(g.synchronize),exec:function(){eXide.app.synchronize()}});
d.addCommand({name:"preferences",bindKey:c(g.preferences),exec:function(){eXide.app.showPreferences()}});d.addCommand({name:"openApp",bindKey:c(g.openApp),exec:function(){eXide.app.openApp()}});d.addCommand({name:"quickfix",bindKey:c(g.quickfix),exec:function(){f.exec("quickFix")}});d.addCommand({name:"expandSelection",bindKey:c(g.expandSelection),exec:function(){f.exec("expandSelection")}});d.addCommand({name:"renameSymbol",bindKey:c(g.renameSymbol),exec:function(){f.exec("rename")}});d.addCommand({name:"removeTags",
bindKey:c(g.removeTags),exec:function(){f.exec("removeTags")}});d.addCommand({name:"extractFunction",hint:"Extract Function",bindKey:c(g.extractFunction),exec:function(){f.exec("extractFunction")}});d.addCommand({name:"extractVariable",hint:"Extract Variable",bindKey:c(g.extractVariable),exec:function(){f.exec("extractVariable")}});d.addCommand({name:"snippet",hint:"code snippet",bindKey:{mac:"Tab",win:"Tab"},exec:function(a){var d=b.expandWithTab(a);d||(d=f.autocomplete(!1));d||a.execCommand("indent")}});
d.addCommand({name:"openTab",hint:"select open tab",bindKey:c(g.openTab),exec:function(){f.selectTab()}});d.addCommand({name:"toggleQueryResults",hint:"toggle query results panel",bindKey:c(g.toggleQueryResults),exec:function(){eXide.app.toggleResultsPanel()}});d.addCommand({name:"commandPalette",hint:"Command Palette",bindKey:c(g.commandPalette),exec:function(){eXide.app.getMenu().commandPalette()}});d.addCommand({name:"findFiles",hint:"Find in files",bindKey:c(g.findFiles),exec:function(){eXide.app.findFiles()}});
for(var h=1;10>h;h++){var j=h;d.addCommand({name:"gotoTab"+j,bindKey:c(g["gotoTab"+j]),exec:l(j)})}g=f.editor.commands;for(key in g.commands)h=g.commands[key],h.bindKey&&(e[h.name]=a.isMac?h.bindKey.mac:h.bindKey.win)}})},help:function(b,d){$(b).find("table").each(function(){this.innerHTML="";var b=d.editor.commands;for(key in b.commands){var c=b.commands[key],e=document.createElement("tr"),f=document.createElement("td");f.appendChild(document.createTextNode(c.name));e.appendChild(f);f=document.createElement("td");
c.bindKey&&(a.isMac?f.appendChild(document.createTextNode(c.bindKey.mac)):f.appendChild(document.createTextNode(c.bindKey.win)));e.appendChild(f);this.appendChild(e)}})},getShortcut:function(a){return e[a]}}}();eXide.namespace("eXide.edit.ModeHelper");
eXide.edit.ModeHelper=function(){var c=require("ace/snippets").snippetManager,a=require("ace/range").Range;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={};this.addCommand("locate",this.locate)};Constr.prototype={activate:function(){},deactivate:function(){},addCommand:function(a,c){this.commands||(this.commands={});this.commands[a]=c},exec:function(a,c,f){if(this.commands&&this.commands[a]){for(var c=[c],d=0;d<f.length;d++)c.push(f[d]);$.log("Calling command %s ...",
a);this.commands[a].apply(this,c)}else eXide.util.message(a+" not supported in this mode.")},validate:function(a,c,f){f&&f(a)},createOutline:function(){d3.select("#outline").selectAll("li").transition().duration(400).style("opacity",0).remove()},documentSaved:function(){},locate:function(a,c,f){"number"==typeof f&&(this.editor.gotoLine(f+1),this.editor.focus());return!1},autocomplete:function(b,e){function f(a){g&&d.editor.getSession().remove(g);c.insertSnippet(d.editor,a.template)}var d=this,g;void 0===
e&&(e=!0);void 0===e&&(e=!0);var l=this.editor.getSelection(),h=l.getSelectionLead(),j=this.editor.renderer.textToScreenCoordinates(h.row,h.column),m;if(l.isEmpty()){l=h.row;m=this.editor.getSession().getDisplayLine(h.row);for(var n=h.column-1,h=h.column;0<=n;){var q=m.substring(n,h);if(q.match(/^\$[\w:\-_\.]+$/))break;if(!q.match(/^[\w:\-_\.]+$/)){n++;break}n--}m=m.substring(n,h);h++;if(""===m&&!e)return!1;g=new a(l,n,l,h)}else if(!e)return!1;eXide.util.Popup.position(j);j=this.getTemplates(b,m,
[]);if(0==j.length)return!1;1<j.length?eXide.util.Popup.show(j,function(a){a&&f(a)}):1==j.length&&f(j[0]);return!0},getTemplates:function(a,c,f){a=eXide.util.Snippets.getTemplates(a,c);for(c=0;c<a.length;c++)f.push({type:"template",label:"[S] "+a[c].name,template:a[c].template,completion:a[c].completion});return f}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function c(a){var b;b=a.line?a["#text"]:a;var d=m.exec(b),c=-1;d?c=parseInt(d[1])-1:a.line&&(c=parseInt(a.line)-1);return{line:c,column:parseInt(a.column||0),msg:b}}var a=/^[\$\w:\-_\.]+/,b=require("lib/visitors/SemanticHighlighter").SemanticHighlighter,e=require("lib/XQueryParser").XQueryParser,f=require("lib/JSONParseTreeHandler").JSONParseTreeHandler,d=require("lib/Translator").Translator,g=require("lib/visitors/CodeFormatter").CodeFormatter;require("lib/Compiler");
var l=require("ace/range").Range,h=require("ace/anchor").Anchor,j=require("ace/snippets").snippetManager;Constr=function(a,b){this.parent=a;this.editor=this.parent.editor;this.xqDebugger=null;this.funcDefRe=/\(:.*declare.+function.+:\)|(declare\s+((?:%[\w\:\-]+(?:\([^\)]*\))?\s*)*)function\s+([^\(]+)\()/g;this.varDefRe=/\(:.*declare.+variable.+:\)|(declare\s+(?:%\w+\s+)*variable\s+\$[^\s;]+)/gm;this.varRe=/declare\s+(?:%\w+\s+)*variable\s+(\$[^\s;]+)/;this.parseImportRe=/\(:[^)]*:\)|(import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;)/g;
this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.trimRe=/^[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+|[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+$/g;this.addCommand("format",this.format);this.addCommand("expandSelection",this.expandSelection);this.addCommand("rename",
this.rename);this.addCommand("extractFunction",this.extractFunction);this.addCommand("extractVariable",this.extractVariable);this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("gotoSymbol",this.gotoSymbol);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule);this.addCommand("quickFix",this.quickFix);this.addCommand("debug",this.initDebugger);this.addCommand("stepOver",
this.stepOver);this.addCommand("stepInto",this.stepInto);var d=this;this.menu=$("#menu-xquery").hide();b.click("#menu-xquery-format",function(){d.format(a.getActiveDocument())});b.click("#menu-xquery-expand",function(){d.expandSelection(a.getActiveDocument())});b.click("#menu-xquery-rename",function(){d.rename(a.getActiveDocument())});b.click("#menu-xquery-extract-function",function(){d.extractFunction(a.getActiveDocument())});b.click("#menu-xquery-extract-variable",function(){d.extractVariable(a.getActiveDocument())});
b.click("#menu-xquery-run-test",function(){d.runTest(a.getActiveDocument())});d.validating=null;d.validationListeners=[]};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.activate=function(){this.menu.show();this.parent.updateStatus("")};Constr.prototype.deactivate=function(){this.menu.hide()};Constr.prototype.afterValidate=function(a,b){this.validationListeners.push({context:a,exec:b})};Constr.prototype.closeTag=function(a,b){var d="xmldb:exist://"+a.getBasePath(),g=this;$.ajax({type:"PUT",
url:"modules/compile.xql",data:b,contentType:"application/octet-stream",headers:{"X-BasePath":d},dataType:"json",success:function(a){if("fail"==a.result){var a=c(a.error),b=/constructor:\s([^\)]+)\)?$/.exec(a.msg);b&&0<b.length?g.editor.insert(b[1]+">"):(b=/tag:.*;\sexpected:\s(.*)$/.exec(a.msg))&&0<b.length&&g.editor.insert(b[1]+">")}},error:function(){}})};Constr.prototype.validate=function(a,b,d){var c=this,g="xmldb:exist://"+a.getBasePath();this.xqlint(a);for(var e=0;e<this.validationListeners.length;e++){var f=
this.validationListeners[e];f.exec.apply(f.context,[a])}this.validationListeners.length=0;$.ajax({type:"PUT",url:"modules/compile.xql",data:b,dataType:"json",headers:{"X-BasePath":g},contentType:"application/octet-stream",success:function(b){b=c.compileError(b,a);d&&d.call(this,b)},error:function(a,b){d&&d.call(this,!1);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.compileError=function(a,b){if("fail"==a.result){var d=c(a.error),g={row:d.line,column:d.column,text:d.msg,type:"error"};
this.parent.updateStatus(d.msg,b.getPath()+"#"+d.line);d=this.clearAnnotations(b,"error");d.push(g);b.getSession().setAnnotations(d);return!1}b.getSession().setAnnotations(this.clearAnnotations(b,"error"));this.parent.updateStatus("");return!0};Constr.prototype.xqlint=function(a){if(!(a.ast&&a.lastValidation>=a.getLastChanged())){$.log("Running xqlint...");var c=a.getSession(),g=a.getText(),h=new f(g),l=new e(g,h);try{l.parse_XQuery()}catch(j){$.log("Error while parsing XQuery: %s",l.getErrorMessage(j)),
j instanceof l.ParseException&&h.closeParseTree()}try{var m=h.getParseTree(),s=new d(m);a.ast=s.translate();a.lastValidation=(new Date).getTime();var i=new b(m,g),o=a.getSession().getMode();o.$tokenizer.tokens=i.getTokens();o.$tokenizer.lines=c.getDocument().getAllLines();c.bgTokenizer.lines=[];c.bgTokenizer.states=[];for(var w=Object.keys(o.$tokenizer.tokens),g=0;g<w.length;g++){var x=parseInt(w[g]);c.bgTokenizer.fireUpdateEvent(x,x)}for(var u=a.ast.markers,z=this.clearAnnotations(a,"warning"),g=
0;g<u.length;g++)"error"!==u[g].type&&z.push({row:u[g].pos.sl,column:u[g].pos.sc,text:u[g].message,type:u[g].type,pos:u[g].pos});c.setAnnotations(z)}catch(A){$.log("Error while processing ast: %s",A.message)}}};Constr.prototype.clearAnnotations=function(a,b){for(var d=[],c=a.getSession().getAnnotations(),g=0;g<c.length;g++)c[g].type!==b&&d.push(c[g]);return d};Constr.prototype.autocomplete=function(a,b){this.xqlint(a);void 0===b&&(b=!0);var d=this.editor.getSelection(),c=a.getSession(),g=d.getSelectionLead(),
e="",f="templates",h;if(d.isEmpty()){var i=eXide.edit.XQueryUtils.findNode(a.ast,{line:g.row,col:g.column});$.log("Autocomplete AST node: %o; doc: %o",i,a.ast);if(i){var o=i.getParent;if("VarRef"===o.name||"VarName"===o.name)f="variables",d=i.pos.sl,h=i.pos.ec,"EQName"===i.name?(e=i.value,c=i.pos.sc-1):c=i.pos.sc,i=o;else{var o=eXide.edit.XQueryUtils.findAncestor(i,"Import"),j=eXide.edit.XQueryUtils.findAncestor(i,"NamespaceDecl");if(o){if(f="modules","NCName"==i.name?e=i.value:"URILiteral"==i.name&&
(d=eXide.edit.XQueryUtils.findSibling(i,"NCName"))&&(e=eXide.edit.XQueryUtils.getValue(d)),d=o.pos.sl,c=o.pos.sc,h=o.pos.ec,o=eXide.edit.XQueryUtils.findNext(o,"Separator"))h=o.pos.ec}else if(j){if(f="namespaces","NCName"==i.name?e=i.value:"URILiteral"==i.name&&(d=eXide.edit.XQueryUtils.findSibling(i,"NCName"))&&(e=eXide.edit.XQueryUtils.getValue(d)),d=j.pos.sl,c=j.pos.sc,h=j.pos.ec,o=eXide.edit.XQueryUtils.findNext(j,"Separator"))h=o.pos.ec}else if("EQName"==i.name)f="functions",e=i.value,d=i.pos.sl,
c=i.pos.sc,h=i.pos.ec;else{if(!b)return!1;d=g.row;h=c=g.column}}}else{f="functions";d=g.row;line=c.getDisplayLine(g.row);c=g.column-1;for(h=g.column;0<=c;){e=line.substring(c,h);if(e.match(/^\$[\w:\-_\.]+$/))break;if(!e.match(/^[\w:\-_\.]+$/)){c++;break}c--}e=line.substring(c,h);h++;if(""===e&&!b)return!1;"$"==e.substring(0,1)&&(f="variables",e=e.substring(1))}d=new l(d,c,d,h)}else f="templates",d=null;if(!b&&"templates"===f)return!1;$.log("completing token: %s, mode: %s, range: %o",e,f,d);g=this.editor.renderer.textToScreenCoordinates(g.row,
g.column);eXide.util.Popup.position(g);"templates"==f?this.templateLookup(a,e,d,!0):"functions"==f?this.functionLookup(a,e,d,!0):"namespaces"==f?this.namespaceLookup(a,e,d,!0):"variables"==f?this.variableLookup(a,i,e,d,!0):this.moduleLookup(a,e,d,!0);return!0};Constr.prototype.variableLookup=function(a,b,d,c,g){"$"==d.substring(0,1)&&(d=d.substring(1));$.log("Lookup variable %s",d);var e=new eXide.edit.InScopeVariables(a.ast,b),b=[],f=d?RegExp("^\\$?"+d):null;if(e=e.getStack())for(var h=0;h<e.length;h++)(!d||
f.test(e[h]))&&b.push({label:e[h],template:"$"+e[h],type:"variable"});for(h=0;h<a.functions.length;h++)"variable"==a.functions[h].type&&(!d||f.test(a.functions[h].name))&&b.push({label:a.functions[h].name,template:"$"+a.functions[h].name,type:"variable"});this.$showPopup(a,c,b,g)};Constr.prototype.functionLookup=function(a,b,d,c){var g=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:b},success:function(e){var e=$.parseJSON(e),f=[],h=RegExp("^"+b);$.each(a.functions,function(a,
b){b.name.match(h)&&f.push(b)});e&&(f=f.concat(e));for(var e=[],l=0;l<f.length;l++){var o={label:f[l].signature?f[l].signature:f[l].name,type:f[l].type};f[l].help&&(o.tooltip=f[l].help);e.push(o)}g.getTemplates(a,b,e);g.$showPopup(a,d,e,c)},error:function(a,b){eXide.util.error(b)}})};Constr.prototype.templateLookup=function(a,b,d,c){var g=[];this.getTemplates(a,b,g);this.$showPopup(a,d,g,c)};Constr.prototype.moduleLookup=function(a,b,d,c){var g=this;$.getJSON("modules/find.xql",{prefix:b},function(b){if(b){for(var e=
[],f=0;f<b.length;f++)e.push({type:"template",label:[b[f].prefix,b[f].uri],tooltip:b[f].at,template:b[f].at?"import module namespace "+b[f].prefix+'="'+b[f].uri+'" at "'+b[f].at+'";':"import module namespace "+b[f].prefix+'="'+b[f].uri+'";'});g.$showPopup(a,d,e,c)}})};Constr.prototype.namespaceLookup=function(a,b,d,c){var g=this;$.getJSON("templates/namespaces.json",function(e){if(e){var f=[],h;for(h in e)(!h||h===b)&&f.push({type:"namespace",label:[h,e[h]],template:"declare namespace "+h+'="'+e[h]+
'";'});g.$showPopup(a,d,f,c)}})};Constr.prototype.gotoSymbol=function(a){for(var b=this,d=[],c=0;c<a.functions.length;c++)item={label:a.functions[c].signature?a.functions[c].signature:a.functions[c].name,name:a.functions[c].name,type:a.functions[c].type},a.functions[c].help&&(item.tooltip=a.functions[c].help),d.push(item);1<d.length&&(this.parent.getWidth(),c=this.parent.getOffset().left,eXide.util.Popup.position({pageX:c,pageY:40}),eXide.util.Popup.show(d,function(d){d&&b.parent.outline.gotoDefinition(a,
d.name)}))};Constr.prototype.$showPopup=function(a,b,d,c){function g(d){if(c){var f=d.label,f="function"==d.type?eXide.util.parseSignature(f):d.template;b&&e.editor.getSession().remove(b);"variable"===d.type?e.editor.insert(f):j.insertSnippet(e.editor,f);d.completion&&e.autocomplete(a)}$.log("template applied")}var e=this;1<d.length||!c?eXide.util.Popup.show(d,function(a){a&&g(a)}):1==d.length&&g(d[0])};Constr.prototype.getFunctionAtCursor=function(b,d){var c,g=eXide.edit.XQueryUtils.findNode(b.ast,
{line:d.row,col:d.column});if(g&&(g=eXide.edit.XQueryUtils.findAncestor(g,"FunctionCall")))c=g.children[0].value;if(!c){c=d.row;c=this.editor.getSession().getDisplayLine(c);g=d.column;do g--;while(0<=g&&c.charAt(g).match(a));g++;for(var e=d.column;e<c.length&&c.charAt(e).match(a);)e++;c=c.substring(g,e)}return c};Constr.prototype.getVariableAtCursor=function(a,b){var d=eXide.edit.XQueryUtils.findNode(a.ast,{line:b.row,col:b.column});if(d&&eXide.edit.XQueryUtils.findAncestor(d,"VarRef")&&"EQName"===
d.name)return d.value};Constr.prototype.showFunctionDoc=function(a){this.xqlint(a);var b=this.editor.getSelection().getSelectionLead(),d=this.editor.renderer.textToScreenCoordinates(b.row,b.column);eXide.util.Popup.position(d);b=this.getFunctionAtCursor(a,b);this.functionLookup(a,b,null,!1)};Constr.prototype.quickFix=function(a,b){b||(b=this.editor.getCursorPosition().row);$.log("Requesting quick fix for %s at %d",a.getName(),b);var d=this.editor.renderer.textToScreenCoordinates(b,0);eXide.util.Popup.position(d);
for(var c=[],g=a.getSession().getAnnotations(),e=0;e<g.length;e++)g[e].row===b&&(d=eXide.edit.XQueryQuickFix.getResolutions(this,this.editor,a,g[e]),$.each(d,function(a,b){c.push({label:b.action,resolve:b.resolve,annotation:g[e]})}));if(0<c.length){var f=this;eXide.util.Popup.show(c,function(b){if(b){b.resolve(f,f.parent,a,b.annotation);f.editor.focus()}})}else $.log("No quick fix resolution found")};Constr.prototype.gotoDefinition=function(a){this.xqlint(a);var b=this.editor.getSelection().getSelectionLead(),
d=this.getFunctionAtCursor(a,b);d?this.parent.outline.gotoDefinition(a,d):(b=this.getVariableAtCursor(a,b))&&this.parent.outline.gotoDefinition(a,b)};Constr.prototype.locate=function(a,b,d){switch(b){case "function":this.gotoFunction(a,d);break;default:this.gotoVarDecl(a,d)}};Constr.prototype.format=function(a){var b=this.editor.getSelectionRange(),d=a.getSession().getTextRange(b);if(0==d.length)eXide.util.error("Please select code to format.");else{var c=a.getSession().doc.getLine(b.start.row).match(/^\s*/)[0],
h=new f(d),d=new e(d,h);try{d.parse_XQuery();for(var l=h.getParseTree(),j=(new g(l,!0)).format().split(/\n/),h=0;h<j.length;h++)j[h]=c+j[h];a.getSession().replace(b,j.join("\n"))}catch(m){console.log("Error parsing XQuery code: %s",d.getErrorMessage(m)),eXide.util.error("Code could not be parsed. Please select a valid code block.")}}};Constr.prototype.extractVariable=function(a){this.xqlint(a);var b=this.editor.getSelectionRange(),d=a.getSession().getTextRange(b);if(0==d.length)eXide.util.error("Please select code to extract.");
else{var c=new h(a.getSession().getDocument(),b.start.row,b.start.column);this.parent.validationEnabled=!1;b=eXide.edit.XQueryUtils.findNode(a.ast,{line:b.start.row,col:b.start.column+1});if(a=eXide.edit.XQueryUtils.findAncestor(b,["IntermediateClause","InitialClause","ReturnClause"]))d="let $${1} := "+d.replace("$","\\$");else{a=eXide.edit.XQueryUtils.findAncestor(b,"StatementsAndOptionalExpr");a=eXide.edit.XQueryUtils.findChild(a,"Expr");if(!a){eXide.util.error("Extract variable: unable to determine context. Giving up.");
return}d="let $${1} := "+d.replace("$","\\$")+"\nreturn"}$.log("extract variable: context: %o",a);this.editor.insert("$");this.editor.gotoLine(a.pos.sl+1,a.pos.sc);this.editor.insert("\n");this.editor.gotoLine(a.pos.sl+1,a.pos.sc);j.insertSnippet(this.editor,d);this.editor.focus();d=this.editor.getSelection();d.toOrientedRange();a=c.getPosition();b=new l(a.row,a.column,a.row,a.column);b.cursor=a;d.addRange(b);c.detach();this.parent.validationEnabled=!0}};Constr.prototype.extractFunction=function(a){this.xqlint(a);
var b=this.editor.getSelectionRange(),c=a.getSession().getTextRange(b);if(0==c.length)eXide.util.error("Please select code to extract.");else{this.parent.validationEnabled=!1;var g=eXide.edit.XQueryUtils.findNode(a.ast,{line:b.start.row,col:b.start.column+1}),j=[],m=new f(c),t=new e(c,m);try{t.parse_XQuery();for(var s=m.getParseTree(),s=(new d(s)).translate(),i=s.markers,s={},m=0;m<i.length;m++)if("error"===i[m].type){var o=/\[XPST0008\]\s"([^"]+)": undeclared variable.*/.exec(i[m].message);o&&2==
o.length&&(s[o[1]]=0)}for(var w in s)j.push(w)}catch(x){eXide.util.error("Not a valid code block: "+t.getErrorMessage(x));return}t=new eXide.edit.PrologAdder(this.parent,a);g=t.getInsertionPoint(g);g=new h(a.getSession().getDocument(),g,0);this.editor.remove(b);i="(";for(m=0;m<j.length;m++)0<m&&(i+=", "),i+="$"+j[m];this.editor.insert(i+")");this.editor.gotoLine(b.start.row,b.start.column);a=new h(a.getSession().getDocument(),b.start.row,b.start.column);t.createFunction(j,c,g.getPosition().row);this.editor.focus();
c=this.editor.getSelection();c.toOrientedRange();j=a.getPosition();b=new l(j.row,j.column,j.row,j.column);b.cursor=j;c.addRange(b);a.detach();g.detach();this.parent.validationEnabled=!0}};Constr.prototype.gotoFunction=function(a,b){$.log("Goto function %s",b);var d=this.getModuleNamespacePrefix();null!=d&&(b=b.replace(/[^:]+:/,d+":"));var c=a.$session.getLength(),g=function(b){for(var d=0;d<c;d++)if(a.$session.getLine(d).match(b))return d};if((d=g(RegExp("function\\s+"+b+"\\s*\\(")))||(d=g(RegExp("function\\s+"+
b+"$"))))return this.parent.history.push(a.getPath(),a.getCurrentLine()),this.editor.gotoLine(d+1),this.editor.focus()};Constr.prototype.gotoVarDecl=function(a,b){var d=this.getModuleNamespacePrefix();null!=d&&(b=b.replace(/[^:]+:/,"$"+d+":"));$.log("Goto variable declaration %s",b);for(var d=RegExp("variable\\s+\\"+b),c=a.$session.getLength(),g=0;g<c;g++)if(a.$session.getLine(g).match(d)){this.parent.history.push(a.getPath(),a.getCurrentLine());this.editor.gotoLine(g+1);this.editor.focus();break}};
Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,b=this.parent.getActiveDocument().$session.getLength(),d=0;d<b;d++){var c=this.parent.getActiveDocument().$session.getLine(d).match(a);if(c)return c[1]}return null};Constr.prototype.importModule=function(a,b,d,c){$.log("location = %s path = %s",c,a.path);if(c)var g=a.getBasePath(),c=0===c.lastIndexOf(g,0)?c.substring(g.length+1):"xmldb:exist://"+c;(new eXide.edit.PrologAdder(this.parent,a)).importModule(b,
d,c)};Constr.prototype.expandSelection=function(a){this.xqlint(a);var b=this.editor.getSelection(),d=b.getRange();if(a=d.start.column==d.end.column&&d.start.line==d.end.line?eXide.edit.XQueryUtils.findNode(a.ast,{line:d.start.row,col:d.start.column}):eXide.edit.XQueryUtils.findNodeForRange(a.ast,{line:d.start.row,col:d.start.column},{line:d.end.row,col:d.end.column})){for(d=a.getParent;d&&eXide.edit.XQueryUtils.samePosition(a.pos,d.pos)&&!(a=d,d=d.getParent,!d););a=new l(d.pos.sl,d.pos.sc,d.pos.el,
d.pos.ec);b.setSelectionRange(a)}};Constr.prototype.rename=function(a){function b(a){c.toOrientedRange();$.each(a,function(a,b){var d=new l(b.pos.sl,b.pos.sc,b.pos.el,b.pos.ec);d.cursor=d.end;c.addRange(d)});d.editor.focus()}this.xqlint(a);var d=this,c=this.editor.getSelection(),g=c.getSelectionLead();if(g=eXide.edit.XQueryUtils.findNode(a.ast,{line:g.row,col:g.column}))if("QName"==g.name&&"DirElemConstructor"==g.getParent.name)a=eXide.edit.XQueryUtils.findSiblings(g,"QName"),a.push(g),b(a);else if("VarName"==
g.getParent.name||"Param"==g.getParent.name)a=eXide.edit.XQueryUtils.getValue(g),(g=eXide.edit.XQueryUtils.findVariableContext(g,a))?(a=(new eXide.edit.VariableReferences(a,g)).getReferences(),b(a)):eXide.util.message("Rename failed: unable to determine context, sorry.");else if("EQName"==g.name&&("FunctionDecl"==g.getParent.name||"FunctionCall"==g.getParent.name)){var e=g.value,g=parseInt(g.getParent.arity);$.log("searching calls to function: %s#%d",e,g);a=new eXide.edit.FunctionCalls(e,g,a.ast);
g=a.getReferences();a.declaration?(g.push(a.declaration),b(g)):eXide.util.message("Rename failed: function declaration not found.")}else eXide.util.message("Please position cursor within variable or function name.");else eXide.util.message("Rename failed: node not found in syntax tree, sorry.")};Constr.prototype.runTest=function(a){var b=this;this.xqlint(a);var d=new eXide.edit.ModuleInfo(a.ast);d.isModule()&&d.hasTests()&&$.ajax({type:"POST",url:"modules/run-test.xql",data:{source:a.getPath()},dataType:"html",
success:function(a){b.parent.updateStatus("");b.parent.clearErrors();eXide.app.showResultsPanel();$(".results-container .results").empty().append(a)},error:function(a){eXide.util.error(a.responseText,"Server Error")}})};Constr.prototype.createOutline=function(a,b){var d=a.getText();this.$parseLocalFunctions(d,a);(d=this.$parseImports(d))?this.$resolveImports(a,d,b):b(a)};Constr.prototype.$sortFunctions=function(a){a.functions.sort(function(a,b){return a.source&&!b.source?1:b.source&&!a.source?-1:
a.name==b.name?0:a.name>b.name?1:-1})};Constr.prototype.$parseLocalFunctions=function(a,b){b.functions=[];for(var d=this.funcDefRe.exec(a),c;null!=(c=d);){if(null!=c[1]){var g=this.funcDefRe.lastIndex,e=this.$findMatchingParen(a,g),d=(4==c.length?c[3]:c[2]).replace(this.trimRe,"");c=4==c.length?c[2]:"public";g=d+"("+a.substring(g,e)+")";-1!==c.indexOf("%private")&&(c="private");b.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:d,visibility:c,signature:g,sort:"$$"+g})}d=this.funcDefRe.exec(a)}for(d=
this.varDefRe.exec(a);null!=d;)null!=d[1]&&(d=this.varRe.exec(d[1]),g=d[1].substr(1).split(":"),g.splice(1,0,":$"),d=d[1],"$"==d.substring(0,1)&&(d=d.substring(1)),b.functions.push({type:eXide.edit.Document.TYPE_VARIABLE,name:d,sort:"$$"+g.join("")})),d=this.varDefRe.exec(a);this.$sortFunctions(b)};Constr.prototype.$findMatchingParen=function(a,b){for(var d=1,c=b;c<a.length;c++){var g=a.charAt(c);if(")"==g){if(d-=1,0==d)return c}else"("==g&&(d+=1)}return-1};Constr.prototype.$parseImports=function(a){for(var b=
[],d=this.parseImportRe,c=d.exec(a);null!=c;)null!=c[1]&&b.push(c[1]),c=d.exec(a);return b};Constr.prototype.$resolveImports=function(a,b,d){for(var c=this,g=[],e=[],f=0;f<b.length;f++){var h=this.moduleRe.exec(b[f]);null!=h&&4==h.length&&(e.push("prefix="+encodeURIComponent(h[1])),e.push("uri="+encodeURIComponent(h[2])),e.push("source="+encodeURIComponent(h[3])))}b="xmldb:exist://"+a.getBasePath();e.push("base="+encodeURIComponent(b));$.ajax({url:"outline",dataType:"json",type:"POST",data:e.join("&"),
success:function(b){if(null!=b){for(var b=b.modules,e=0;e<b.length;e++){var f=b[e].functions;if(f)for(var h=0;h<f.length;h++)g.push({type:eXide.edit.Document.TYPE_FUNCTION,name:f[h].name,signature:f[h].signature,visibility:f[h].visibility,source:b[e].source,sort:f[h].signature});if(f=b[e].variables)for(h=0;h<f.length;h++){var l=f[h].split(":");l.splice(1,0,":$");g.push({type:eXide.edit.Document.TYPE_VARIABLE,name:f[h],source:b[e].source,sort:l.join("")})}}a.functions=a.functions.concat(g);c.$sortFunctions(a)}d&&
d(a)}});return g};Constr.prototype.initDebugger=function(a){this.xqDebugger=new eXide.XQueryDebuger(this.editor,a);this.xqDebugger.init()};Constr.prototype.stepOver=function(){this.xqDebugger&&this.xqDebugger.stepOver()};Constr.prototype.stepInto=function(){this.xqDebugger&&this.xqDebugger.stepInto()};var m=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){var c=require("ace/token_iterator").TokenIterator,a=require("ace/range").Range;Constr=function(a,c){var f=this;this.parent=a;this.editor=this.parent.editor;this.menu=$("#menu-xml").hide();c.click("#menu-xml-rename",function(){f.rename(a.getActiveDocument())});c.click("#menu-xml-select-element",function(){f.selectElement(a.getActiveDocument())});c.click("#menu-xml-remove-tag",function(){f.deleteTags(a.getActiveDocument())});this.addCommand("closeTag",this.closeTag);
this.addCommand("removeTags",this.deleteTags);this.addCommand("suggest",this.suggest);this.addCommand("rename",this.rename);this.addCommand("expandSelection",this.selectElement)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.activate=function(){this.menu.show();this.editor.setOption("enableEmmet",this.parent.enableEmmet)};Constr.prototype.deactivate=function(){this.menu.hide();this.editor.setOption("enableEmmet",!1)};Constr.prototype.closeTag=function(a,c,f){a.getBasePath();
var d=this;$.ajax({type:"PUT",url:"check/",data:c,contentType:"application/octet-stream",dataType:"json",success:function(a){a.status&&"invalid"==a.status&&parseInt(a.message.line)-1<=f&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]))&&0<a.length&&d.editor.insert(a[1]+">")},error:function(){}})};Constr.prototype.validate=function(a,c,f){var d=this;$.ajax({type:"PUT",url:"modules/validate-xml.xql",data:c,contentType:"application/octet-stream",dataType:"json",success:function(c){d.compileError(c,
a);f.call(this,!0)},error:function(a,b){f.call(this,!0);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.compileError=function(a,c){$.log("Validation returned %o",a);if(a.status&&"invalid"==a.status){var f;f=a.message instanceof Array?a.message:[a.message];for(var d=[],g=0;g<f.length;g++)d.push({row:parseInt(f[g].line)-1,text:f[g]["#text"],type:"error"});this.parent.updateStatus(f[0]["#text"],c.getPath()+"#"+f[0].line);c.getSession().setAnnotations(d)}else this.parent.clearErrors(),
this.parent.updateStatus("")};Constr.prototype.suggest=function(a,c,f,d){$.log("Getting suggestions for %s",c);$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:c,row:f,column:d},dataType:"json",success:function(d){$this.compileError(d,a);onComplete.call(this,!0)},error:function(a,b){onComplete.call(this,!0);$.log("Compile error: %s - %s",b,a.responseText)}})};Constr.prototype.documentSaved=function(a){if(/.*\.xconf$/.test(a.getName())){var c=a.getBasePath();eXide.util.Dialog.input("Apply Configuration?",
"You have saved a collection configuration file. Would you like to apply it to collection "+c.replace(/^\/db\/system\/config/,"")+" now?",function(){eXide.util.message("Apply configuration and reindex...");$.ajax({type:"POST",url:"modules/apply-config.xql",data:{collection:a.getBasePath(),config:a.getName()},dataType:"json",success:function(a){a.error?eXide.util.error("Failed to apply configuration: "+a.error):eXide.util.success("Configuration applied.")},error:function(a){eXide.util.error("Failed to apply configuration: "+
a.responseText)}})})}};Constr.prototype.selectElement=function(b){var e=this.findStartEndTags(b,!1);if(e.start){for(var f=new c(b.getSession(),e.end.row,e.end.column),d=f.stepForward();d;){if(">"===d.value){e.end.row=f.getCurrentTokenRow();e.end.column=f.getCurrentTokenColumn()+1;break}d=f.stepForward()}f=new c(b.getSession(),e.start.row,e.start.column);for(d=f.getCurrentToken();d;){if("<"===d.value){e.start.row=f.getCurrentTokenRow();e.start.column=f.getCurrentTokenColumn();break}d=f.stepBackward()}b=
this.editor.getSelection();e=new a(e.start.row,e.start.column,e.end.row,e.end.column);b.setSelectionRange(e)}};Constr.prototype.rename=function(b){b=this.findStartEndTags(b,!0);if(b.start){var c=this.editor.getSelection(),f=new a(b.start.row,b.start.column,b.start.row,b.start.column+b.start.name.length);f.cursor=f.end;c.setSelectionRange(f);c.toOrientedRange();b.end&&(f=new a(b.end.row,b.end.column,b.end.row,b.end.column+b.end.name.length),f.cursor=f.end,c.addRange(f));this.editor.focus()}};Constr.prototype.deleteTags=
function(a){var c=this.findStartEndTags(a,!1);if(c.start){var f=this.selectTag(a,c.end);a.getSession().remove(f);f=this.selectTag(a,c.start);a.getSession().remove(f)}};Constr.prototype.findStartEndTags=function(a){function e(a,d){var b=a.getCurrentTokenColumn();return a.getCurrentTokenRow()==d.row&&d.column>=b&&d.column<=b+a.getCurrentToken().value.length}for(var f=this.editor.getSelection().getRange().start,a=new c(a.getSession(),0,0),d=[],g=!1,l=a.stepForward(),h,j;l;){if(/^(meta.tag.name|.*.tag-name.xml)/.test(l.type)){if(g){if(g=
d.pop(),h==g||h&&h.stack==d.length||e(a,f)){h=g;j={name:l.value,row:a.getCurrentTokenRow(),column:a.getCurrentTokenColumn()};break}}else l={name:l.value,length:l.value.length,row:a.getCurrentTokenRow(),column:a.getCurrentTokenColumn(),stack:d.length},d.push(l),e(a,f)&&(h=l);g=!1}else"</"===l.value?g=!0:"/>"===l.value?d.pop():e(a,f)&&(h=d[d.length-1]);l=a.stepForward()}return{start:h,end:j}};Constr.prototype.selectTag=function(b,e){for(var f=new a(e.row,e.column,e.row,e.column),d=new c(b.getSession(),
e.row,e.column),g=d.stepForward();g;){if(">"===g.value){f.end.row=d.getCurrentTokenRow();f.end.column=d.getCurrentTokenColumn()+1;break}g=d.stepForward()}d=new c(b.getSession(),e.row,e.column);for(g=d.getCurrentToken();g;){if("<"===g.value||"</"===g.value){f.start.row=d.getCurrentTokenRow();f.start.column=d.getCurrentTokenColumn();break}g=d.stepBackward()}return f};return Constr}();eXide.namespace("eXide.edit.LessModeHelper");
eXide.edit.LessModeHelper=function(){function c(a,b){$.ajax({url:"store/"+a,type:"PUT",data:b,dataType:"json",contentType:"text/css",success:function(d){if("error"==d.status)return eXide.util.error(d.message);eXide.util.message(a+" stored.")},error:function(a){eXide.util.error(a.responseText)}})}var a=require("ace/token_iterator").TokenIterator,b=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(b,eXide.edit.ModeHelper);b.prototype.documentSaved=
function(a){var b=a.getExternalLink(),d=a.getText();if(/\/_.+\.less$/.test(b))return eXide.util.error("CSS not compiled for include : "+b);var g="/**\n * THIS IS A GENERATED FILE\n * to make changes edit\n * "+b+"\n */\n\n";less.render(d,{filename:b},function(d,h){if(d)return eXide.util.error("Error: "+d.message);eXide.util.message("Compiled less file: "+b);var j=a.getPath().replace(/\.less$/,".css");c(j,g+h.css)})};b.prototype.saveCSS=c;b.prototype.createOutline=function(b,c){for(var d=new a(b.getSession(),
0,0),g=d.stepForward();null!=g;){if("paren.lparen"==g.type&&"{"==g.value){for(var g=[],l=d.getCurrentTokenRow(),h=new a(b.getSession(),l,d.getCurrentTokenColumn()),j;null!=(j=h.stepBackward())&&!(h.getCurrentTokenRow()<l);)g.push(j.value);g=g.reverse().join("");b.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:g,source:b.getPath(),signature:g,sort:g,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()});lastVar=""}g=d.stepForward()}c&&c(b)};return b}();eXide.namespace("eXide.edit.JavascriptModeHelper");
eXide.edit.JavascriptModeHelper=function(){var c=/^[\$\w\-_]+/,a=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("gotoSymbol",this.gotoSymbol)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(b,c){for(var f=new a(b.getSession(),0,0),d=f.stepForward();null!=d;)"entity.name.function"==d.type&&
b.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:d.value,signature:d.value,sort:d.value,row:f.getCurrentTokenRow(),column:f.getCurrentTokenColumn()}),d=f.stepForward();c&&c(b)};Constr.prototype.gotoSymbol=function(a){for(var c=this,f=[],d=0;d<a.functions.length;d++)item={label:a.functions[d].name,name:a.functions[d].name,type:a.functions[d].type,row:a.functions[d].row},f.push(item);1<f.length&&(d=this.parent.getOffset().left,eXide.util.Popup.position({pageX:d,pageY:20}),eXide.util.Popup.show(f,
function(d){d&&(c.parent.history.push(a.getPath(),a.getCurrentLine()),c.editor.gotoLine(d.row+1));c.editor.focus()}))};Constr.prototype.gotoDefinition=function(a){var c=this.editor.getSelection().getSelectionLead();(c=this.getFunctionAtCursor(c))&&this.locate(a,null,c)};Constr.prototype.locate=function(a,c,f){if("number"==typeof f)this.editor.gotoLine(f+1);else if((c=this.parent.outline.findDefinition(a,f))&&c.row)this.parent.history.push(a.getPath(),a.getCurrentLine()),this.editor.gotoLine(c.row+
1)};Constr.prototype.getFunctionAtCursor=function(a){var e=a.row,e=this.editor.getSession().getDisplayLine(e),f=a.column;do f--;while(0<=f&&e.charAt(f).match(c));f++;for(a=a.column;a<e.length&&e.charAt(a).match(c);)a++;return e.substring(f,a)};return Constr}();eXide.namespace("eXide.edit.CssModeHelper");
eXide.edit.CssModeHelper=function(){var c=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate);this.addCommand("gotoSymbol",this.gotoSymbol)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(a,b){for(var e=new c(a.getSession(),0,0),f=e.stepForward(),d="";null!=f;)"variable"==f.type||"keyword"==f.type?(0<d.length&&(d+=" "),d+=f.value):"paren.rparen"==f.type?d="":
"paren.lparen"==f.type&&""!==d&&(a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:d,source:a.getPath(),signature:d,sort:d,row:e.getCurrentTokenRow(),column:e.getCurrentTokenColumn()}),d=""),f=e.stepForward();b&&b(a)};Constr.prototype.gotoSymbol=function(a){for(var b=this,c=[],f=0;f<a.functions.length;f++)""!==a.functions[f].name&&(item={label:a.functions[f].name,name:a.functions[f].name,type:a.functions[f].type,row:a.functions[f].row},c.push(item));1<c.length&&(f=this.parent.getOffset().left,
eXide.util.Popup.position({pageX:f,pageY:40}),eXide.util.Popup.show(c,function(d){d&&(b.parent.history.push(a.getPath(),a.getCurrentLine()),b.editor.gotoLine(d.row+1))}))};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.currentDoc=null;this.__activated=!1;var c=this;$("#outline-filter").keyup(function(){c.filter(this.value)})};Constr.prototype={toggle:function(c){this.__activated=c||!1===c?!!c:!this.__activated;d3.select("#outline-body").style("position",this.__activated?"relative":"absolute");this.__activated&&this.currentDoc&&this.updateOutline(this.currentDoc)},getTemplates:function(c){for(var c=RegExp("^"+c),a=[],b=0;b<this.templates.length;b++)this.templates[b].name.match(c)&&
a.push(this.templates[b]);return a},gotoDefinition:function(c,a){var b="function";0===a.indexOf("$")&&(a=a.substring(1),b="variable");$.each(c.functions,function(c,f){if(a==f.name&&b==f.type){eXide.app.locate(f.type,f.source==""?null:f.source,a);return false}})},findDefinition:function(c,a){for(var b=0;b<c.functions.length;b++){var e=c.functions[b];if(a==e.name)return e}return null},updateOutline:function(c){var a=this;a.currentDoc=c;var b=c.getModeHelper();null!=b&&this.__activated&&(c.functions=
[],b.createOutline(c,function(){a.$outlineUpdate(c)}))},clearOutline:function(){$("#outline").empty()},filter:function(c){var a=RegExp(c,"i");$("#outline li a").each(function(){var b=$(this);a.test(b.text())?b.show():b.hide()})},$outlineUpdate:function(c){this.currentDoc==c&&(eXide.app.resize(),c=d3.select("#outline").selectAll("li").data(c.functions,function(a){return a.sort}),c.enter().append("li").attr("class",function(a){return a.type==eXide.edit.Document.TYPE_FUNCTION?"ace_support.ace_function":
"ace_variable"}).append("a").style("opacity",0).attr("title",function(a){return a.signature?a.signature:null}).attr("href",function(a){return"#"+(a.source?a.source:"")}).attr("class",function(a){return(a.type==eXide.edit.Document.TYPE_FUNCTION?"t.function":"t_variable")+" "+("private"===a.visibility?"private":"public")}).text(function(a){return a.type==eXide.edit.Document.TYPE_VARIABLE?"$"+a.name:a.name}).on("click",function(a){var b=this.hash.substring(1);a.row?eXide.app.locate("function",""==b?
null:b,parseInt(a.row)):a.type==eXide.edit.Document.TYPE_FUNCTION?eXide.app.locate("function",""==b?null:b,a.name):eXide.app.locate("variable",""==b?null:b,a.name)}).transition().duration(800).style("opacity",1),c.exit().transition().duration(400).style("opacity",0).remove(),c.sort(function(a,b){var c;if(null==a||null==b)c=-1;else{c=a.sort;var f=b.sort;c=c.toLowerCase();f=f.toLowerCase();c=c>f?1:c==f?0:-1}return c}))}};return Constr}();eXide.namespace("eXide.edit.Directory");
eXide.edit.Directory=function(){function c(a){return"fa "+(a.isCollection?"fa-folder"+(a.isOpen?"-open":""):a.isResourceOpen?"fa-edit":"")}function a(d){var b=this instanceof d3.selection?this:d3.select(this),l=eXide.app.getEditor();if(!b.empty()){var h=function(d){b.selectAll("ul, span, i").remove();var h=b.datum(d).attr("class",function(a){return a.isCollection?"collection":"resource"}).attr("data-key",function(a){return a.key}).style("cursor","pointer").on("click",f).on("dblclick",e);h.append("i").attr("class",
c);h.append("span").text(function(a){return a.name});d.children&&d.children.length&&b.append("ul").selectAll("li").data(d.children).enter().append("li").each(a)};if(d)return d=d.length?d[0]:d,d.isCollection||(d.isResourceOpen=!!l.getDocument(d.key)),h(d);d3.json("modules/collections.xql?root="+(b.datum().key||"/db")+"&view=r",function(a,d){if(!a){var c=b.datum();c.isOpen=!0;c.isLoaded=!0;c.children=d.items.filter(function(a){return".."!=a.name});h(c)}})}}function b(a){eXide.app.$doOpenDocument({name:a.name,
path:a.key,writable:a.writable})}function e(a){d3.event.stopPropagation();!a.isCollection&&a.isResourceOpen&&(b(a),eXide.app.closeDocument())}function f(d){d3.event.stopPropagation();if(d.isCollection){d.isOpen||eXide.app.syncManager(d.key);if(d.isLoaded){d.isOpen=!d.isOpen;var g=d3.select(this);g.select("i.fa").attr("class",c);d.isOpen?d=a.call(this):(g.selectAll("ul").remove(),d=void 0);return d}a.call(this)}else b(d)}Constr=function(){this.currentDoc=null;this.__activated=!1;a.call(d3.select("#tree-root"),
[{key:"/db",isCollection:!0,isOpen:!1,name:"db",isLoaded:!1}])};Constr.prototype={toggle:function(a){this.__activated=a||!1===a?!!a:!this.__activated;d3.select("#directory-body").style("position",this.__activated?"relative":"absolute")},clearDirectory:function(){$("#directory").empty()},reload:function(d){d=d3.select("[data-key='"+d+"']");d.empty()||a.call(d)},toggleEdit:function(a,b){var e=d3.select("[data-key='"+a+"']");if(!e.empty()){var f=e.datum();f.isResourceOpen=b||!f.isResourceOpen;e.select("i.fa").attr("class",
c)}}};return Constr}();eXide.namespace("eXide.edit.XQueryDebuger");
eXide.XQueryDebuger=function(){Constr=function(c,a){this.doc=a;this.count=0;this.session="";this.existURL="xmldb:exist://"+document.location.hostname+":"+document.location.port;this.editor=c};Constr.prototype.init=function(){this.count++;$.log("init "+this.existURL+this.doc.getPath()+" times "+this.count);this.runCommand({action:"init"})};Constr.prototype.stepOver=function(){this.runCommand({action:"step"})};Constr.prototype.stepInto=function(){this.runCommand({action:"step-into"})};Constr.prototype.stepOut=
function(){this.runCommand({action:"step-out"})};Constr.prototype.runCommand=function(c){var a=this;c.session=this.session;c.resource=this.existURL+this.doc.getPath();$.ajax({type:"POST",url:"modules/debuger.xql",data:c,dataType:"json",success:function(b){$.log("response: %o",b);a.session=b.session;a.editor.gotoLine(b.stack[0].lineno);b.context&&b.context.properties&&$.each(b.context.properties,function(b,c){var d=a.getVariable(c);$(d).appendTo($("div#debuger.content tbody#variables"))});eXide.util.message("Good response. Session: "+
a.session)},error:function(a,c){eXide.util.error(a.responseText,"Server Error in session "+c)}})};Constr.prototype.getVariable=function(c){var a=$('<tr><td class="name"></td><td class="type"></td><td class="value"></td></tr>');a.children(".name").append(c.name);a.children(".type").append(c.type);"node"===c.type?a.children(".value").append($('<div id="valueHighLight">'+c.value+"</div>")):a.children(".value").append(c.value);return a};return Constr}();eXide.namespace("eXide.edit.CodeValidator");
eXide.edit.CodeValidator=function(){function c(a){a=a.getModeHelper();return!a||!a.validate?!1:!0}Constr=function(a){this.editor=a;this.inProgress=!1;this.enabled=!0;this.deferred=this.validateTimeout=null};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.triggerDelayed=function(a){if(this.enabled&&c(a)&&a.needsValidation()){var b=this,e=(new Date).getTime();this.validateTimeout&&700>e-a.lastChangeEvent&&clearTimeout(this.validateTimeout);this.deferred=$.Deferred();this.validateTimeout=
setTimeout(function(){b.triggerNow.apply(b,[a])},700)}};Constr.prototype.triggerNow=function(a){if(!this.enabled||!c(a)||!a.needsValidation())return null;if(this.inProgress)return this.deferred;var b=this;this.deferred||(this.deferred=$.Deferred());this.inProgress=!0;a.getModeHelper().validate(a,a.getText(),function(c){a.lastValidation=(new Date).getTime();b.inProgress=false;b.deferred.resolve([c]);b.deferred=null;b.$triggerEvent("validate",[a]);c&&b.$triggerEvent("documentValid",[a])});return this.deferred};
Constr.prototype.setEnabled=function(a){this.enabled=a};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(c,a,b){this.name=c;this.path=a.replace(/\/{2,}/g,"/");this.mime=null;this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.$session=b;this.externalLink=null;this.lastChangeEvent=(new Date).getTime();this.lastValidation=0;this.ast=null;c=eXide.app.getPreference("softWrap");this.$session.setUseWrapMode(0!=c);0<c?this.$session.setWrapLimitRange(c,c):0>c&&this.$session.setWrapLimitRange(null,null);this.$session.setFoldStyle("markbegin")};
Constr.TYPE_FUNCTION="function";Constr.TYPE_VARIABLE="variable";Constr.TYPE_TEMPLATE="template";Constr.prototype.needsValidation=function(){return this.isNew()&&this.isSaved()?!1:!this.ast||this.lastChangeEvent>this.lastValidation};Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.setText=function(c){this.$session.setValue(c)};Constr.prototype.getName=function(){return this.name};Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(c){this.path=
c};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};Constr.prototype.setMime=function(c){this.mime=c};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.setSyntax=function(c){this.syntax=c};Constr.prototype.getSession=function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};Constr.prototype.isNew=function(){return/__new__/.test(this.path)};Constr.prototype.isEditable=
function(){return this.editable};Constr.prototype.isXQuery=function(){return"application/xquery"==this.mime};Constr.prototype.setModeHelper=function(c){this.helper=c};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.getCurrentLine=function(){return this.$session.getSelection().getSelectionLead().row};Constr.prototype.getLastChanged=function(){return this.lastChangeEvent};Constr.prototype.getExternalLink=function(){return this.externalLink};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var c=require("ace/virtual_renderer").VirtualRenderer,a=require("ace/editor").Editor,b=require("ace/edit_session").EditSession,e=require("ace/undomanager").UndoManager;require("ace/snippets");require("ace/lib/net");var f=require("ace/lib/event");Constr=function(d,b,e){var h=this;h.container=d;h.menubar=b;h.projects=e;h.documents=[];h.activeDoc=null;h.recent=[];h.tabCounter=0;h.newDocCounter=0;h.pendingCheck=!1;h.recheck=!1;h.enableEmmet=!1;h.themes={};h.initializing=!0;
h.history=new eXide.edit.History;h.tabs=$("#tabs");d=new c(h.container,"ace/theme/eclipse");d.setShowGutter(!0);this.editor=new a(d);this.editor.setBehavioursEnabled(!0);this.editor.setShowFoldWidgets(!0);this.editor.setFadeFoldWidgets(!1);require("ace/multi_select").MultiSelect(this.editor);eXide.edit.commands.init(h);f.addCommandKeyListener(window,h.onCommandKey.bind(h));b.editor=this;this.outline=new eXide.edit.Outline;this.directory=new eXide.edit.Directory;this.validator=new eXide.edit.CodeValidator(this);
this.addEventListener("activate",this.outline,this.outline.updateOutline);this.validator.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();var b=this.pathname,a=this.hash.substring(1);if(b=h.getDocument(b))h.switchTo(b),h.editor.gotoLine(parseInt(a)+1)});var j=$("#tabs-container");j.css({overflow:"hidden"});
j.mousemove(function(a){var b=j.find("ul"),d=j.width(),b=b.find("li");1<b.length&&(b=b[b.length-2].offsetLeft+b.outerWidth(),a=(a.pageX-j.offset().left)*(b-d)/d,j.scrollLeft(a))});this.validateTimeout=null;this.validationEnabled=!0;d=new eXide.edit.XMLModeHelper(h,b);h.modes={xquery:new eXide.edit.XQueryModeHelper(h,b),xml:d,html:d,less:new eXide.edit.LessModeHelper(h),javascript:new eXide.edit.JavascriptModeHelper(h),css:new eXide.edit.CssModeHelper(h),tmsnippet:new eXide.edit.SnippetModeHelper(h)};
$("#dialog-goto-line").dialog({modal:!1,autoOpen:!1,height:200,width:300,buttons:{Goto:function(){var a=$(this).find('input[name="row"]').val(),b=$(this).find('input[name="column"]').val();b&&""!=b?h.editor.gotoLine(a,b-1,!0):h.editor.gotoLine(a,0,!0);$(this).dialog("close");h.editor.focus()},Cancel:function(){$(this).dialog("close");h.editor.focus()}},open:function(){$(this).find("input[name='row']").val("");$(this).find("input[name='column']").val("");$(this).find("input:first").focus();var a=$(this);
a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});this.editor.on("guttermousedown",function(a){!a.getButton()&&"markers"==h.editor.renderer.$gutterLayer.getRegion(a)&&(a=a.getDocumentPosition().row,h.exec("quickFix",a))});$(".drop-placeholder .tab",h.tabs).droppable({hoverClass:"dragover",greedy:!0,drop:function(a,b){a.stopImmediatePropagation();a.stopPropagation();a.preventDefault();var d=$(this),c=$(".tab",h.tabs),g=b.draggable,
c=c.index(g),e=h.documents[c];g.parent().detach().insertBefore(d.parent());h.documents.splice(c,1);h.documents.push(e);h.rebuildBuffersMenu()}});var m=[{label:"outline",cls:"outline"},{label:"directory",cls:"directory"}];d3.select("#tabs-outline").selectAll("li").data(m).enter().append("li").append("a").attr("class","tab").text(function(a){return a.label}).on("click",function(a,d){d3.selectAll("#tabs-outline a.tab").classed("active",function(a,b){return b==d});m.map(function(a,c){return b.editor[a.cls].toggle(c==
d)})}).each(function(a,d){0===d&&d3.select(this).classed("active",!0);b.editor[a.cls].toggle(0===d)})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.onCommandKey=function(a,b,c){var e=$(a.target);if(e.is(":input")||"autocomplete-box"==e.attr("id")||0<e.parents(".eXide-browse-resources").length)return!1;this.editor.onCommandKey(a,b,c)};Constr.prototype.init=function(){0==this.documents.length&&this.newDocument(null,"xquery");this.initializing=!1;var a=this.getActiveDocument();
this.$triggerEvent("activate",[a])};Constr.prototype.setEmmetEnabled=function(a){this.enableEmmet=a;this.editor.setOption("enableEmmet",a)};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var a=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}else eXide.util.message("Not supported in this mode.")};Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};
Constr.prototype.newDocument=function(a,c){for(var e=0,f=0;f<this.documents.length;f++)this.documents[f].path.match(/^__new__(\d+)/)&&(e=parseInt(RegExp.$1));e++;f=a&&"string"==typeof a?new b(a):c&&"xquery"===c?new b('xquery version "3.1";\n\n'):new b("");e=new eXide.edit.Document("new-document "+e,"__new__"+e,f);e.saved=!0;c?e.setSyntax(c):e.setSyntax("text");this.$initDocument(e,!0)};Constr.prototype.newDocumentWithText=function(a,c,e){a=new eXide.edit.Document(e.name,e.path,new b(a));a.editable=
e.writable;a.mime=c;a.syntax=eXide.util.mimeTypes.getLangFromMime(c);a.saved=!1;e.line&&this.editor.gotoLine(e.line);this.$initDocument(a)};Constr.prototype.newDocumentFromTemplate=function(a,c){if(!c||0==c.length)this.newDocument(null,a);else{var e=this;$.ajax({url:"modules/get-template.xql",type:"POST",data:{template:c},dataType:"text",success:function(f){for(var j=0,m=0;m<e.documents.length;m++)e.documents[m].path.match(/^__new__(\d+)/)&&(j=parseInt(RegExp.$1));j++;f=new b(f);j=new eXide.edit.Document("new-document "+
j,"__new__"+j,f);j.setSyntax(a);j.template=c;e.$initDocument(j,!0)}})}};Constr.prototype.openDocument=function(a,c,e,f){e.writable?eXide.util.message("Opening "+e.path):eXide.util.message("Opening "+e.path+" readonly!");/\.snippet/.test(e.name)?c="application/tmsnippet":/\.less/.test(e.name)&&(c="application/less");console.log("mime type: %s",c);a=new eXide.edit.Document(e.name,e.path,new b(a));a.editable=e.writable;a.mime=c;a.syntax=eXide.util.mimeTypes.getLangFromMime(c);a.externalLink=f;a.saved=
!0;e.line&&(c=a.$session.getSelection(),c.clearSelection(),c.moveCursorTo(e.line,1),a.$session.setScrollTop(e.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",e.name,a.mime,a.syntax,e.line);this.updateStatus("");this.activeDoc&&(e=this.activeDoc.getModeHelper())&&e.deactivate(a);this.$initDocument(a);this.directory.toggleEdit(this.activeDoc.getPath(),!0)};Constr.prototype.$initDocument=function(a,b){var c=this;c.$setMode(a,b);a.$session.setUndoManager(new e);a.$session.addEventListener("change",
function(){a.saved&&(a.saved=!1,c.updateTabStatus(a.path,a));a.lastChangeEvent=(new Date).getTime();c.validator.triggerDelayed(a)});c.addTab(a);c.editor.setSession(a.$session);c.editor.resize();c.editor.focus();a.$session.getDocument().on("change",function(){c.$triggerEvent("change",[c.activeDoc]);c.history.push(a.getPath(),a.getCurrentLine())});eXide.app.toggleRunStatus(a);a.getModeHelper()&&a.getModeHelper().activate(a)};Constr.prototype.setMode=function(a){this.activeDoc.syntax=a;this.$setMode(this.activeDoc,
!0)};Constr.prototype.$setMode=function(a,b){var c;switch(a.getSyntax()){case "xquery":c=new (require("eXide/mode/xquery").Mode)(this);c.$id="xquery";a.$session.setMode(c);b&&(a.mime="application/xquery");break;case "xml":c=new (require("eXide/mode/xml").Mode)(this);c.$id="xml";a.$session.setMode(c);b&&(a.mime="application/xml");break;case "html":c=new (require("eXide/mode/html").Mode)(this);c.$id="html";a.$session.setMode(c);b&&(a.mime="html"==a.template?"text/html":"application/xhtml+xml");break;
case "javascript":c=new (require("ace/mode/javascript").Mode);c.$id="javascript";a.$session.setMode(c);b&&(a.mime="application/x-javascript");break;case "css":c=new (require("ace/mode/css").Mode);c.$id="css";a.$session.setMode(c);b&&(a.mime="text/css");break;case "text":c=require("ace/mode/text").Mode;a.$session.setMode(new c);b&&(a.mime="text/text");break;case "less":c=new (require("ace/mode/less").Mode);c.$id="less";a.$session.setMode(c);b&&(a.mime="application/less");break;case "tmsnippet":c=require("ace/mode/snippets").Mode;
a.$session.setUseSoftTabs(!1);a.$session.setMode(new c);b&&(a.mime="application/tmsnippet");break;case "json":c=require("ace/mode/json").Mode;a.$session.setUseSoftTabs(!1);a.$session.setMode(new c);b&&(a.mime="application/json");break;case "markdown":c=require("ace/mode/markdown").Mode,a.$session.setMode(new c),b&&(a.mime="text/x-markdown")}eXide.util.Snippets.init(a.getSyntax());(c=this.modes[a.getSyntax()])||(c=new eXide.edit.ModeHelper(this));a.setModeHelper(c)};Constr.prototype.closeDocument=
function(a){a=a||this.activeDoc;this.$triggerEvent("close",[a]);$('#tabs a[title="'+a.path+'"]').parent().remove();this.menubar.remove("buffers",a.path);for(var b=0;b<this.documents.length;b++)this.documents[b].path==a.path&&this.documents.splice(b,1);0==this.documents.length?this.newDocument(null,"xquery"):(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.directory.toggleEdit(a.getPath(),
!1),this.$triggerEvent("activate",[this.activeDoc]))};Constr.prototype.saveDocument=function(a,b,c){var e=this,f=e.activeDoc.path,m=e.activeDoc.name;a&&(e.activeDoc.path=a.path,e.activeDoc.name=a.name);eXide.util.message("Storing resource "+e.activeDoc.name+"...");$.ajax({url:"store"+e.activeDoc.path,type:"PUT",data:e.activeDoc.getText(),dataType:"json",contentType:e.activeDoc.mime?e.activeDoc.mime:"application/octet-stream",success:function(a){if(a.status=="error"){e.activeDoc.path=f;e.activeDoc.name=
m;c?c.apply(e.activeDoc,[a.message]):eXide.util.error(a.message)}else{e.activeDoc.saved=true;e.activeDoc.externalLink=a.externalLink;e.updateTabStatus(f,e.activeDoc);b?b.apply(e.activeDoc):eXide.util.success(e.activeDoc.name+" stored.");(a=e.activeDoc.getModeHelper())&&a.documentSaved(e.activeDoc);e.$triggerEvent("saved",[e.activeDoc])}},error:function(a){e.activeDoc.path=f;e.activeDoc.name=m;c?c.apply(e.activeDoc,a.responseText):eXide.util.error(a.responseText)}})};Constr.prototype.reload=function(a){this.activeDoc.getSession().setValue(a);
this.activeDoc.saved=!0;this.updateTabStatus(this.activeDoc.path,this.activeDoc)};Constr.prototype.getDocument=function(a){for(var a=eXide.util.normalizePath(a),b=0;b<this.documents.length;b++)if(this.documents[b].path==a)return this.documents[b];return null};Constr.prototype.onInput=function(a,b){var c=a.getModeHelper();if(c&&c.onInput)c.onInput(a,b)};Constr.prototype.historyBack=function(){var a=this.history.pop();a&&($.log("history event: going to %s at line %d",a.path,a.line),eXide.app.findDocument(a.path,
a.line+1))};Constr.prototype.autocomplete=function(a){var b=this.activeDoc.getModeHelper();return b&&b.autocomplete?b.autocomplete(this.activeDoc,a):!1};Constr.prototype.getHeight=function(){return $("#fullscreen").height()};Constr.prototype.getWidth=function(){return $(this.container).width()};Constr.prototype.getOffset=function(){return $(this.container).offset()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};
Constr.prototype.forEachDocument=function(a){for(var b=this.documents.slice(0),c=0;c<b.length;c++)a(b[c])};Constr.prototype.gotoLine=function(){$("#dialog-goto-line").dialog("open");$("#dialog-goto-line input[type='text']").val("");$('#dialog-goto-line input[name="row"]').focus()};Constr.prototype.addTab=function(a){var b=this,c="t"+b.tabCounter++,e=a.name;16<e.length&&(e=e.substring(0,13)+"...");a.saved||(e+="*");$("li a",b.tabs).removeClass("active");var f=document.createElement("li"),m=document.createElement("a");
m.appendChild(document.createTextNode(e));m.className="tab active";m.id=c;m.title=a.path;f.appendChild(m);$(m).click(function(c){c.preventDefault();b.switchTo(a)}).draggable({axis:"x",revert:!0,opacity:0.8,zIndex:100,start:function(){$(".drop-placeholder .tab",b.tabs).show()},stop:function(){$(".drop-placeholder .tab",b.tabs).hide()}}).droppable({hoverClass:"dragover",greedy:!0,drop:function(a,c){a.stopImmediatePropagation();a.stopPropagation();a.preventDefault();var d=$(this),e=$(".tab",b.tabs),
f=c.draggable,h=e.index(f),e=e.index(d);h!=e&&(f.parent().detach().insertBefore(d.parent()),b.documents.splice(e,0,b.documents[h]),b.documents.splice(h>e?h+1:h,1),b.rebuildBuffersMenu())}});$(f).insertBefore($(".drop-placeholder",b.tabs));b.menubar.add("buffers",e,m.title,b.documents.length+1,function(){b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.initializing||b.$triggerEvent("activate",[a]);b.scrollToTab($(m))};Constr.prototype.rebuildBuffersMenu=function(){var a=this;a.menubar.removeAll("buffers");
a.documents.forEach(function(b,c){var e=b.name;16<e.length&&(e=e.substring(0,13)+"...");b.saved||(e+="*");a.menubar.add("buffers",e,b.path,c+1,function(){a.switchTo(b)})})};Constr.prototype.selectTab=function(a){var b=this;if(0<=a&&a<this.documents.length)this.switchTo(this.documents[a]);else{for(var a=[],c=0;c<this.documents.length;c++)item={label:this.documents[c].name,pos:c},a.push(item);1<a.length&&(c=this.getOffset().left,eXide.util.Popup.position({pageX:c,pageY:40}),eXide.util.Popup.show(a,
function(a){a&&b.switchTo(b.documents[a.pos])}))}};Constr.prototype.switchTo=function(a){var b=this.activeDoc.getModeHelper();b&&b.deactivate(a);this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;var c=this;$("a",c.tabs).each(function(){var b=$(this);this.title==a.path?(b.addClass("active"),c.scrollToTab(b)):b.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a]);eXide.app.toggleRunStatus(a);(b=a.getModeHelper())&&b.activate(a);this.activeDoc.ast||
this.validator.triggerNow(this.activeDoc)};Constr.prototype.updateTabStatus=function(a,b){var c;c=b.saved?b.name:b.name+"*";$('a[title="'+a+'"]',this.tabs).attr("title",b.path).text(c)};Constr.prototype.scrollToTab=function(a){var b=a.offset().left,a=b+a.outerWidth(),c=$("#tabs-container").innerWidth(),e=$("#tabs-container").scrollLeft();a>c?$("#tabs-container").scrollLeft(a-c):b<e&&(b<c?$("#tabs-container").scrollLeft(0):$("#tabs-container").scrollLeft(b));$.log("Scrolling to %d %d",b,$("#tabs-container").scrollLeft())};
Constr.prototype.setTheme=function(a){$.log("Changing theme to %s",a);var b=this;b.loadTheme(a,function(){b.editor.setTheme("ace/theme/"+a);b.$triggerEvent("setTheme",[require(b.editor.getTheme())])})};Constr.prototype.loadTheme=function(a,b){if(this.themes[a])return b();require("ace/lib/net");this.themes[a]=1;var c="$shared/resources/scripts/ace/theme-"+a.split("/").pop()+".js",e=document.getElementsByTagName("head")[0],f=document.createElement("script");f.src=c;e.appendChild(f);f.onload=b};Constr.prototype.updateStatus=
function(a,b){$(this.status).text(a);b&&(this.status.href=b)};Constr.prototype.evalError=function(a,b){var c=/.*line\s(\d+)/i.exec(a),e=-1;c&&(e=parseInt(c[1]));b&&(this.editor.focus(),this.editor.gotoLine(e));c=[{row:e-1,text:a,type:"error"}];this.updateStatus(a);this.editor.getSession().setAnnotations(c)};Constr.prototype.focus=function(){this.editor.focus()};Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,c){if(c.path.match("^__new__.*")){var e=c.getText();e&&0<e.length&&
(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".data"]=c.getText(),localStorage["eXide."+a+".last-line"]=c.getCurrentLine())}else localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".writable"]=c.editable?"true":"false",localStorage["eXide."+a+".last-line"]=c.getCurrentLine(),c.saved||(localStorage["eXide."+
a+".data"]=c.getText());a++});localStorage["eXide.documents"]=a};return Constr}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(c){Constr=function(){this.projects={}};Constr.prototype.findProject=function(a,b){var c=this.getProjectFor(a);c&&null!==c?b(c):this.getProject(a,b)};Constr.prototype.getProject=function(a,b){var e=this;$.getJSON("modules/deployment.xql",{info:a},function(a){if(a){var d=e.projects[a.abbrev];d?c.extend(d,a):(d=a,e.projects[a.abbrev]=d);"function"==typeof b&&b(d)}else"function"==typeof b&&b(null)})};Constr.prototype.getProjectFor=function(a){for(k in this.projects){var b=this.projects[k];
if(a.substring(0,b.root.length)===b.root)return b}return null};Constr.prototype.saveState=function(){localStorage["eXide.projects"]=JSON.stringify(this.projects)};Constr.prototype.restoreState=function(){var a=this;localStorage["eXide.projects"]&&(this.projects=JSON.parse(localStorage["eXide.projects"]),"object"!=typeof this.projects&&(this.projects={}));$.each(this.projects,function(){this.root&&a.getProject(this.root)})};return Constr}(eXide.util.oop);eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(c){var a=this;this.projects=c;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({appendTo:"#layout-container",title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.runDialog=$("#dialog-run-app");this.runDialog.dialog({appendTo:"#layout-container",modal:!1,autoOpen:!1,width:300,height:240,buttons:{Done:function(){$(this).dialog("close")}}});this.runDialog.find("input[name='live-reload']").click(function(){a.currentProject.liveReload=
$(this).is(":checked");$("#menu-deploy-live span").attr("class",a.currentProject.liveReload?"fa fa-check-square-o":"fa fa-square-o")});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({appendTo:"#layout-container",title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:440,buttons:{Apply:function(){var b=a.syncDialog.find('input[name="dir"]').val();b&&0<b.length&&(a.currentProject.dir=b);a.currentProject.autoSync=a.syncDialog.find('input[name="auto"]').is(":checked");
$(this).dialog("close")},Synchronize:function(){var b=a.syncDialog.find('input[name="dir"]').val();!b||0==b.length?$("#synchronize-report").text("No output directory specified!"):(a.currentProject.dir=b,b=a.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",b))},Close:function(){$(this).dialog("close")}}});this.gitCheckoutDialog=$("#dialog-git-checkout");this.gitCheckoutDialog.dialog({appendTo:"#layout-container",
title:"Git Checkout",modal:!1,autoOpen:!1,width:500,height:240,buttons:{"Switch Branch":function(){var b=$("[name='git-checkout']",a.gitCheckoutDialog.find("form")).val();eXide.app.git.command(a.currentProject,"checkout",b,function(){$("#toolbar-current-branch").text(b);$("#menu-git-active").text(b)});$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});this.gitCommitDialog=$("#dialog-git-commit");this.gitCommitDialog.dialog({appendTo:"#layout-container",title:"Synchonize and Commit",
modal:!1,autoOpen:!1,width:500,height:360,buttons:{"Sync and Commit":function(){var b=a.gitCommitDialog.find("form"),c=$("[name='git-commit-title']",b).val(),f=$("[name='git-commit-desc']",b).val(),d=c+"\n\n"+f,b=$("[name='start']",b).val();!c||0==c.length?$("#git-commit-status").text("title for commit message is required"):($("#git-commit-status").text("Synchronization in progress ..."),$("#git-commit-status").load("modules/synchronize.xql",{collection:a.currentProject.root,start:b},function(b,c){"success"==
c&&eXide.app.git.command(a.currentProject,"commit",d)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.open=function(c){var a=this,b=null;c&&(b={collection:c});$.ajax({url:"modules/deployment.xql",type:"POST",data:b,success:function(b){a.container.html(b);a.container.form({done:function(){var b=a.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:b,success:function(b){a.container.dialog("close");
a.$triggerEvent("change",[b])},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){a.container.dialog("close")}});a.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});a.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.deploy=function(c){var a=this;eXide.util.Dialog.input("Deploy",'<p>Note: target has to be different from the source package or it will be overwritten!</p><p><label for="target">Target collection:</label><input id="deployment-target" type="text" name="target" value="'+
c+'-test"size="30"/></p>',function(){var b=$("#deployment-target").val();""===b&&(b=c);$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:{collection:c,target:b,deploy:"true"},success:function(b){b=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+b+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+b+'" target="_new">'+b+"</a></center>");
a.$triggerEvent("change",c)},error:function(a){404==a.status?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})})};Constr.prototype.download=function(c){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(c)};Constr.prototype.synchronize=function(c){var a=this;a.projects.findProject(c,
function(b){b?eXide.app.login.isAdmin?($("#synchronize-report").empty(),a.currentProject=b,a.syncDialog.find(".project-name").text(b.abbrev),a.syncDialog.find('input[name="start"]').val(b.deployed),b.dir?a.syncDialog.find('input[name="dir"]').val(b.dir):a.syncDialog.find('input[name="dir"]').val(""),a.syncDialog.find('input[name="collection"]').val(b.root),a.syncDialog.find('input[name="auto"]').attr("checked",b.autoSync),a.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):
eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.autoSync=function(c){(c=this.projects.getProjectFor(c))&&c.autoSync&&$.ajax({url:"modules/synchronize.xql",type:"GET",data:{collection:c.root,start:c.deployed,dir:c.dir},success:function(){eXide.util.message("Synchronized directory")}})};Constr.prototype.runApp=function(c){var a=this;a.projects.findProject(c,function(b){if(b){a.runDialog.find("input[name='live-reload']").prop("checked",
b.liveReload);a.currentProject=b;var c=b.url.replace(/\/{2,}/,"/"),c=eXide.configuration.context+c+"/";a.runDialog.find("a").attr("href",c).attr("target",b.abbrev).text(c);a.runDialog.find(".first-load").show();a.runDialog.find(".second-load").hide();a.runDialog.dialog("open")}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.saveState=function(){this.projects.saveState()};Constr.prototype.restoreState=
function(){this.projects.restoreState()};Constr.prototype.gitCheckout=function(c){var a=this;a.projects.findProject(c,function(b){b?eXide.app.login.isAdmin?(a.currentProject=b,b=d3.select("#git-checkout-select").selectAll("option").data(b.gitBranch).attr("value",function(a){return a}).text(String),b.enter().append("option").attr("value",function(a){return a}).text(String),b.exit().remove(),a.gitCheckoutDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):
eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.gitCommit=function(c){var a=this;a.projects.findProject(c,function(b){b?eXide.app.login.isAdmin?(a.currentProject=b,a.gitCommitDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};
return Constr}();eXide.namespace("eXide.util.Menubar");
eXide.util.Menubar=function(){Constr=function(c){var a=this;this.container=c;this.editor=null;this.commands={};var b=!1;$("ul li>a",this.container).click(function(){var c=$(this),f=$("ul li>a.open",a.container);0<f.length?(f.removeClass("open"),f.next("ul").fadeOut(100,function(){c.addClass("open");c.next("ul").fadeIn(100)})):(c.addClass("open"),c.next("ul").fadeIn(200));b=!0;return!1});$("body").click(function(){b&&($("ul li ul",a.container).fadeOut(100),$("ul li>a",a.container).removeClass("open"))})};
Constr.prototype.commandPalette=function(){var c=this,a=[],b;for(b in c.commands)a.push(c.commands[b]);1<a.length&&(b=this.editor.getOffset().left,eXide.util.Popup.position({pageX:b,pageY:40}),eXide.util.Popup.show(a,function(a){a&&(a.callback(),c.editor&&c.editor.focus())}))};Constr.prototype.click=function(c,a,b){var e=this,c=$(c),f=c.text();b||(b=c.attr("data-command"));if(b){var d=eXide.edit.commands.getShortcut(b);d&&(d=d.replace(/Command/g,String.fromCharCode(8984)),d=d.replace(/Shift/g,String.fromCharCode(8679)),
d=d.replace(/Option/g,String.fromCharCode(8997)),d=d.replace(/Control/g,"^"),c.each(function(){var a=document.createElement("span");a.className="shortcut";a.appendChild(document.createTextNode(d));this.appendChild(a)}))}c.attr("id")&&(e.commands[c.attr("id")]={label:[f,c.find(".shortcut").text()],callback:a});c.click(function(b){b.preventDefault();a();e.editor&&e.editor.focus();$("ul li ul",e.container).fadeOut(100);$("ul li>a",e.container).removeClass("open")})};Constr.prototype.add=function(c,a,
b,e,f){var d=this,g="";10>e&&(g='<span class="shortcut">'+eXide.edit.commands.getShortcut("gotoTab"+e)+"</span>");var c=$(this.container).find('ul li[title="'+c+'"]'),l=c.find("ul");l.append($('<li><a href="#" title="'+b+'">'+a+g+"</a></li>"));l.find("li:last-child a").click(function(a){a.preventDefault();l.fadeOut(100);$("ul li>a",d.container).removeClass("open");f();d.editor&&d.editor.focus()})};Constr.prototype.remove=function(c,a){c=$(this.container).find('ul li[title="'+c+'"]');c.find('ul li a[title = "'+
a+'"]').remove()};Constr.prototype.removeAll=function(c){c=$(this.container).find('ul li[title="'+c+'"] ul');c.empty()};return Constr}();eXide.namespace("eXide.util.Help");
eXide.util.Help=function(){var c=null,a=-1;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-help">\t<div class="help" id="eXide-dialog-help-body"></div></div>');helpDialog=$("#eXide-dialog-help");helpDialog.dialog({appendTo:"#layout-container",modal:!1,title:"Quick Start",autoOpen:!1,width:600,height:400,buttons:{OK:function(){$(this).dialog("close")},Next:function(){eXide.util.Help.next()},Previous:function(){eXide.util.Help.previous()}}})});return{show:function(){helpDialog.dialog("open");
c?eXide.util.Help.next():eXide.util.Help.load()},next:function(){a+1<c.length&&(a++,$("#eXide-dialog-help-body").html(c[a]))},previous:function(){0<a&&(a--,$("#eXide-dialog-help-body").html(c[a]))},showFirstTime:function(){if(eXide.util.supportsHtml5Storage){var a=localStorage.getItem("eXide.hints");(!a||1==a)&&eXide.util.Help.show()}},load:function(){$.ajax({url:"help.html",type:"GET",success:function(a){c=$("section",a);eXide.util.Help.show()},error:function(a){404==a.status?eXide.util.error("Failed to open help texts."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>");helpDialog.dialog("close")}})}}}();eXide.namespace("eXide.util.Preferences");
eXide.util.Preferences=function(){var c={theme:"tomorrow",fontSize:14,font:"Default",showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,indent:-1,indentSize:4,softWrap:-1,emmet:!1};Constr=function(a){this.editor=a;this.preferences=$.extend({},c);var b=this,e=$("#preferences-dialog");$("select, input",e).change(function(){b.updatePreferences()});$("#preferences-dialog").dialog({appendTo:"#layout-container",title:"Preferences",modal:!1,autoOpen:!1,height:400,width:600,buttons:{Close:function(){$(this).dialog("close");
a.focus()},"Reset Defaults":function(){b.preferences=$.extend({},c);b.updateForm()}}})};Constr.prototype.show=function(){this.updateForm();$("#preferences-dialog").dialog("open")};Constr.prototype.updateForm=function(){var a=$("#preferences-dialog form");$('select[name="theme"]',a).val(this.preferences.theme);$('select[name="font-size"]',a).val(this.preferences.fontSize);$('select[name="font"]',a).val(this.preferences.font);$('input[name="show-invisibles"]',a).attr("checked",this.preferences.showInvisibles);
$('input[name="print-margin"]',a).attr("checked",this.preferences.showPrintMargin);$('input[name="emmet"]',a).attr("checked",this.preferences.emmet);var b=this.preferences.indent,c=this.preferences.indentSize;0===b?b="Tabs":-1===b&&(b="Spaces");$('select[name="indent"]',a).val(b);$('select[name="indent-size"]',a).val(c);b=this.preferences.softWrap;0===b?b="off":-1===b&&(b="free");$('input[name="soft-wrap"]',a).val(b)};Constr.prototype.updatePreferences=function(){var a=$("#preferences-dialog form");
this.preferences.theme=$('select[name="theme"]',a).val();this.preferences.fontSize=parseInt($('select[name="font-size"]',a).val());this.preferences.font=$('select[name="font"]',a).val();this.preferences.showInvisibles=$('input[name="show-invisibles"]',a).is(":checked");this.preferences.showPrintMargin=$('input[name="print-margin"]',a).is(":checked");this.preferences.emmet=$('input[name="emmet"]',a).is(":checked");var b=$('select[name="indent"]',a).val(),c=parseInt($('select[name="indent-size"]',a).val(),
10);"Spaces"===b?b=-1:"Tabs"===b&&(b=0);this.preferences.indent=parseInt(b,10);this.preferences.indentSize=parseInt(c,10);a=$('select[name="soft-wrap"]',a).val();"free"===a?a=-1:"off"===a&&(a=0);this.preferences.softWrap=parseInt(a,10);this.applyPreferences()};Constr.prototype.applyPreferences=function(){var a=this;this.editor.setTheme(this.preferences.theme);this.editor.editor.setShowInvisibles(this.preferences.showInvisibles);this.editor.editor.setShowPrintMargin(this.preferences.showPrintMargin);
this.editor.setEmmetEnabled(this.preferences.emmet);this.editor.forEachDocument(function(b){0<a.preferences.softWrap?b.getSession().setWrapLimitRange(a.preferences.softWrap,a.preferences.softWrap):0>a.preferences.softWrap&&b.getSession().setWrapLimitRange(null,null);b.getSession().setUseWrapMode(0!=a.preferences.softWrap);0>a.preferences.indent?(b.getSession().setTabSize(a.preferences.indentSize),b.getSession().setUseSoftTabs(!0)):0<=a.preferences.indent&&b.getSession().setUseSoftTabs(!1)});if(this.preferences.font){var b=
this.preferences.font+", monospace";$("#editor").css("font-family",b);$("#outline").css("font-family",b);$("#results-body").css("font-family",b)}this.editor.editor.setFontSize(this.preferences.fontSize+"px");this.editor.resize()};Constr.prototype.get=function(a){return this.preferences[a]};Constr.prototype.read=function(){var a=!1;localStorage["eXide.preferences"]&&(this.preferences=JSON.parse(localStorage.getItem("eXide.preferences")),a=this.preferences.version===eXide.app.version());this.preferences.version=
eXide.app.version();this.applyPreferences();return a};Constr.prototype.save=function(){localStorage.setItem("eXide.preferences",JSON.stringify(this.preferences));localStorage.setItem("eXide.firstTime",0)};return Constr}();$(document).ready(function(){window.name="eXide";jQuery.event.props.push("dataTransfer");var c;var a=window.location.search.substr(1).split("&");if(""==a)c={};else{for(var b={},e=0;e<a.length;++e){var f=a[e].split("=");2==f.length&&(b[f[0]]=decodeURIComponent(f[1].replace(/\+/g," ")))}c=b}eXide.app.init(function(){var a=c.snip;c.open?eXide.app.findDocument(c.open):a&&eXide.app.newDocument(a,"xquery");window.opener&&window.opener.eXide_onload&&window.opener.eXide_onload(eXide.app)})});eXide.namespace("eXide.app");
eXide.app=function(c){var a,b,e,f,d,g,l={},h,j=null,m=0,n=0,q=0,p=0,y=!0,v=!0,r="south",t={html:1,javascript:1,css:1,less:1},s=function(a){c.error("Failed to apply configuration: "+a.responseText)},i={init:function(b){Modernizr.flexbox?(d=new eXide.edit.Projects,h=new c.Menubar($(".menu")),a=new eXide.edit.Editor(document.getElementById("editor"),h),e=new eXide.edit.PackageEditor(d),f=new eXide.browse.Browser(document.getElementById("open-dialog")),f.addEventListener("upload-open",function(a){y=!a}),
e.addEventListener("change",null,function(a){f.changeToCollection(a);i.openDocument()}),g=new c.Preferences(a),a.addEventListener("setTheme",i.setTheme),i.initGUI(h),(new eXide.util.DnD("body")).addEventListener("drop",i.dropFile),i.getLogin(function(){i.initStatus("Restoring state");i.restoreState(function(c){a.init();b&&b(c);eXide.configuration.allowGuest?$("#splash").fadeOut(400):i.requireLogin(function(){$("#splash").fadeOut(400)})})}),a.addEventListener("outlineChange",i.onOutlineChange),a.validator.addEventListener("documentValid",
function(a){a.isXQuery()&&$("#live-preview").is(":checked")&&i.runQuery(a.getPath(),!0)}),a.addEventListener("saved",function(a){$("#live-preview").is(":checked")&&t[a.getSyntax()]&&document.getElementById("results-iframe").contentDocument.location.reload(!0)}),$(window).resize(i.resize),$(window).unload(function(){i.saveState()}),eXide.find.Modules.addEventListener("open",null,function(a){i.findDocument(a.at)}),eXide.find.Modules.addEventListener("import",null,function(b){a.exec("importModule",b.prefix,
b.uri,b.at)})):$("#startup-error").show()},version:function(){return $("#eXide-version").text()},hasFocus:function(){return v},getEditor:function(){return a},getMenu:function(){return h},resize:function(b){$("#editor");if(b){var b=$(".panel-"+r),c=$("#results-body");$("#results-iframe").width(c.innerWidth());$("#results-iframe").height(b.innerHeight()-$(".navbar",b).height()-8);$("#results-body").height(b.innerHeight()-$(".navbar",b).height()-8)}a.resize()},beforeResize:function(){"html"==$("#serialization-mode").val()&&
$("#results-iframe").css("display","none")},afterResize:function(){a.resize();"html"==$("#serialization-mode").val()&&$("#results-iframe").css("display","")},newDocument:function(b,c){a.newDocument(b,c)},newDocumentFromTemplate:function(){$("#dialog-templates").dialog("open")},dropFile:function(a){if(y)if(Modernizr.filereader)for(var b=new FileReader,d=0;d<a.length;d++){var e=eXide.util.mimeTypes.getLangFromMime(a[d].type)||"xquery";b.onloadend=function(){i.newDocument(this.result,e)};b.readAsText(a[d])}else c.message("Your browser does not support drag and drop of files.")},
findDocument:function(b,c){var d=a.getDocument(b);null==d?(d={name:b.match(/[^\/]+$/)[0],path:b},i.$doOpenDocument(d,function(){c&&a.editor.gotoLine(c)})):(a.switchTo(d),c&&a.editor.gotoLine(c))},locate:function(b,c,d){if(null==c)a.exec("locate",b,d);else{var e=a.getDocument(c);null==e?(c={name:c.match(/[^\/]+$/)[0],path:c},i.$doOpenDocument(c,function(c){c&&a.exec("locate",b,d)})):(a.switchTo(e),a.exec("locate",b,d))}},openDocument:function(){f.reload(["reload"],"open");$("#open-dialog").dialog("option",
"title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");a.focus()},open:i.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=f.getSelection();b&&i.$doOpenDocument(b);(void 0==a||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(b,d,e){b.path=c.normalizePath(b.path);var f=a.getDocument(b.path);if(f&&!e)return a.switchTo(f),d&&d(b),!0;$.ajax({url:"modules/load.xql?path="+b.path,dataType:"text",
success:function(f,g,h){e?a.reload(f):(g=c.mimeTypes.getMime(h.getResponseHeader("Content-Type")),h=h.getResponseHeader("X-Link"),a.openDocument(f,g,b,h));d&&d(b);return!0},error:function(a){c.error("Failed to load document "+b.path+": "+a.status+" "+a.statusText);d&&d(null);return!1}})},reloadDocument:function(){var b=a.getActiveDocument();b.isSaved()?i.$reloadDocument(b):c.Dialog.input("Reload Document","Do you really want to reload the document?",function(){i.$reloadDocument(b)})},$reloadDocument:function(a){a=
{name:a.getName(),path:a.getPath()};i.$doOpenDocument(a,null,!0)},closeDocument:function(){a.getActiveDocument().isSaved()?a.closeDocument():$("#dialog-confirm-close").dialog({appendTo:"#layout-container",resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");a.closeDocument()},Cancel:function(){$(this).dialog("close")}},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(0)").focus();$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(1)").blur()}})},
closeAll:function(){a.forEachDocument(function(b){b.isSaved()?a.closeDocument(b):c.message("Not closing unsaved document "+b.getName())})},saveDocument:function(){i.requireLogin(function(){a.getActiveDocument().getPath().match("^__new__")?(f.reload(["reload","create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(f.getSelection(),function(){$("#open-dialog").dialog("close");
e.autoSync(a.getActiveDocument().getBasePath());i.updateStatus(this);i.syncDirectory(this.getBasePath());i.liveReload()},function(a){c.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):a.saveDocument(null,function(){c.message(a.getActiveDocument().getName()+" stored.");e.autoSync(a.getActiveDocument().getBasePath());i.liveReload()},function(a){c.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){i.requireLogin(function(){f.reload(["reload",
"create"],"save");$("#open-dialog").dialog("option","title","Save Document As ...");$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){a.saveDocument(f.getSelection(),function(){$("#open-dialog").dialog("close");e.autoSync(a.getActiveDocument().getBasePath());i.updateStatus(this);i.syncDirectory(this.getBasePath());i.liveReload()},function(a){c.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){a.exec(arguments)},
download:function(){var b=a.getActiveDocument();b.getPath().match("^__new__")||!b.isSaved()?c.error("There are unsaved changes in the document. Please save it first."):window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(b.getPath())},runQuery:function(b,d){function e(){a.updateStatus("");a.clearErrors();i.showResultsPanel();q=n=1}if(!eXide.configuration.allowExecution&&!i.login.isAdmin)c.error("You are not allowed to execute XQuery code.");else switch(a.getActiveDocument().getSyntax()){case "html":e();
var f=document.getElementById("results-iframe");$(f).show();b?f.src=a.getActiveDocument().getExternalLink():$(f).contents().find("html").html(a.getText());$("#serialization-mode").attr("disabled","disabled").val("html");break;case "javascript":e();f=document.getElementById("results-iframe");$(f).show();var g=a.getText();$(f).contents().find("html").html('<script type="text/javascript">'+g+"<\/script>");$("#serialization-mode").attr("disabled","disabled").val("html");break;default:g=a.getText();if(b)if(g=
a.getDocument(b))g=g.$session.getValue();else break;else j=a.getActiveDocument().getPath();a.updateStatus("Running query ...");$("#serialization-mode").removeAttr("disabled");var h=$("#serialization-mode").val(),f="xmldb:exist://"+a.getActiveDocument().getBasePath();$(".results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"adaptive"==h||"html5"==h||"xhtml"==h||"xhtml5"==h||"json"==h||"text"==h||"xml"==h||"microxml"==h?"xml":"text",data:{qu:g,base:f,output:h},success:function(b){switch(h){case "adaptive":case "html5":case "xhtml":case "xhtml5":case "json":case "text":case "xml":case "microxml":$("#results-iframe").hide();
b=b.documentElement;"error"==b.nodeName?(b=$(b).text(),a.evalError(b,!d)):(e(),m=b.getAttribute("hits"),p=n+10-1,m<p&&(p=m),c.message("Query returned "+m+" item(s) in "+b.getAttribute("elapsed")+"s"),i.retrieveNext());break;default:e();var f=document.getElementById("results-iframe");$(f).show();f.contentWindow.document.open("text/html","replace");f.contentWindow.document.write(b);f.contentWindow.document.close()}},error:function(a){c.error(a.responseText,"Server Error")}})}},checkQuery:function(){a.validator.triggerNow(a.getActiveDocument())},
retrieveNext:function(){$.log("retrieveNext: %d",q);if(0<q&&q<=p){$("#serialization-mode").removeAttr("disabled");var a=$("#serialization-mode").val(),b=$("#auto-expand-matches").is(":checked"),c=$("#indent-results").is(":checked"),d="results/"+q;q++;$.ajax({url:d,dataType:"html",data:{output:a,"auto-expand-matches":b,indent:c},success:function(a){$(".results-container .results").append(a);$(".results-container .current").text("Showing results "+n+" to "+(q-1)+" of "+m);$(".results-container .pos:last a").click(function(){i.findDocument($(this).data("path"));
return!1});i.retrieveNext()}})}},browseNext:function(){0<q&&p<m&&(n=q,p=q+10-1,m<p&&(p=m),$(".results-container .results").empty(),i.retrieveNext());return!1},browsePrevious:function(){0<q&&1<n&&(n-=10,1>n&&(n=1),q=n,p=q+9,m<p&&(p=m),$(".results-container .results").empty(),i.retrieveNext());return!1},syncDirectory:function(b){a.directory.reload(b)},syncManager:function(a){$("#open-dialog").is(":visible")&&(f.resources.collection=a,f.resources.reload())},manage:function(){i.requireLogin(function(){f.reload("reload create upload properties open cut copy paste".split(" "),
"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option","buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},deploymentSettings:function(){var b=a.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(b);c&&i.requireLogin(function(){$.log("Editing deployment settings for collection: %s",c[1]);e.open(c[1])})},newDeployment:function(){i.requireLogin(function(){e.open()})},deploy:function(){i.requireLogin(function(){var b=
a.getActiveDocument().getPath(),b=/^(.*)\/[^\/]+$/.exec(b);if(!b)return c.error("The file open in the editor does not belong to an application package!"),!1;$.log("Deploying application from collection: %s",b[1]);e.deploy(b[1])});return!1},synchronize:function(){i.requireLogin(function(){var b=a.getActiveDocument().getPath();(b=/^(.*)\/[^\/]+$/.exec(b))?e.synchronize(b[1]):c.error("The file open in the editor does not belong to an application package!")})},gitCheckout:function(){i.requireLogin(function(){var b=
a.getActiveDocument().getPath();(b=/^(.*)\/[^\/]+$/.exec(b))?e.gitCheckout(b[1]):c.error("The file open in the editor does not belong to an application package!")})},gitCommit:function(){i.requireLogin(function(){var b=a.getActiveDocument().getPath();(b=/^(.*)\/[^\/]+$/.exec(b))?e.gitCommit(b[1]):c.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){i.requireLogin(function(){var b=a.getActiveDocument().getPath(),b=/^(.*)\/[^\/]+$/.exec(b);$.log("downloading %s",
b);b?e.download(b[1]):c.error("The file open in the editor does not belong to an application package!")})},openApp:function(b){var d=a.getActiveDocument().getPath();(d=/^(.*)\/[^\/]+$/.exec(d))?e.runApp(d[1],b):c.error("The file open in the editor does not belong to an application package!")},runAppOrQuery:function(){var b=a.getActiveDocument(),c=d.getProjectFor(b.getPath());if(c){var e=c.url.replace(/\/{2,}/,"/"),f=eXide.configuration.context+e+"/";i.ensureSaved(function(){c.win=window.open(f,c.abbrev);
c.win.focus()})}else!b.isNew()&&"xquery"==b.getSyntax()&&i.ensureSaved(function(){window.open(b.getExternalLink(),b.getName())})},toggleRunStatus:function(a){var b=d.getProjectFor(a.getPath())||!a.isNew()&&"xquery"==a.getSyntax();$("#run").button("option","disabled",!b);b="xquery"==a.getSyntax()||"html"==a.getSyntax()||"javascript"==a.getSyntax();$("#eval").button("option","disabled",!b)},ensureSaved:function(b){a.getActiveDocument().isSaved()?b():i.requireLogin(function(){eXide.util.Dialog.input("Save document?",
"The current document has not been saved. Save now?",function(){a.saveDocument(null,function(){c.message(a.getActiveDocument().getName()+" stored.");b()},function(a){c.Dialog.warning("Failed to Save Document",a)})})})},restoreState:function(d){if(!c.supportsHtml5Storage)return!1;var f=g.read();f||c.Dialog.message("Version Note","It seems another version of eXide has been used from this browser before. If you experience any display issues, please clear your browser's cache (holding shift while clicking on the reload icon should usually be sufficient).");
b.restoreState(f);var h={};(f=localStorage["eXide.documents"])||(f=0);for(var j=[],l=0;l<f;l++){var m={path:localStorage["eXide."+l+".path"],name:localStorage["eXide."+l+".name"],writable:"true"==localStorage["eXide."+l+".writable"],line:parseInt(localStorage["eXide."+l+".last-line"])};if(m.name){$.log("Restoring doc %s, going to line = %i",m.path,m.line);var n=localStorage["eXide."+l+".data"];n?a.newDocumentWithText(n,localStorage["eXide."+l+".mime"],m):j.push(m);h[m.path]=m}}this.restoreDocs(j,
function(){if(a.getActiveDocument()){var b=localStorage["eXide.activeTab"];b&&i.findDocument(b)}else i.newDocument("","xquery");a.validator.triggerNow(a.getActiveDocument());d&&d(h)});e.restoreState();return h},restoreDocs:function(b,c){if(0==b.length)c();else{var d=this,e=b.pop();i.$doOpenDocument(e,function(){e.line&&a.editor.gotoLine(e.line+1);d.restoreDocs(b,c)})}},saveState:function(){c.supportsHtml5Storage&&(localStorage.clear(),g.save(),b.saveState(),localStorage["eXide.layout.resultPanel"]=
r,a.getActiveDocument()&&(localStorage["eXide.activeTab"]=a.getActiveDocument().path),a.saveState(),e.saveState())},getLogin:function(a){$.ajax({url:"login",type:"POST",dataType:"json",success:function(b){b&&b.user?(i.login=b,$("#user").text("Logged in as "+i.login.user+". "),a&&a(i.login.user)):(i.login=null,a&&a(null))},error:function(){i.login=null;$("#user").text("Login");a&&a(null)}})},enforceLogin:function(){i.requireLogin(function(){(!i.login||"guest"===i.login.user)&&i.enforceLogin()})},$checkLogin:function(){if(i.login)return!0;
c.error("Warning: you are not logged in.");return!1},requireLogin:function(a){i.login?a():($("#login-dialog").dialog("option","close",function(){i.login?a():c.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"),$("#login-dialog input:first").focus())},showPreferences:function(){g.show()},getPreference:function(a){return g.get(a)},startDebug:function(){var b=$("#debug span.ui-icon");b.hasClass("ui-icon-stop")?(b.removeClass("ui-icon-stop"),b.addClass("ui-icon-play")):(b.removeClass("ui-icon-play"),
b.addClass("ui-icon-stop"));a.exec("debug");$.log("start debugging click")},stepOver:function(){a.exec("stepOver")},stepInto:function(){a.exec("stepInto")},setTheme:function(a){$("#outline-body,#directory-body,#results-body ").removeClass().addClass(a.cssClass)},updateStatus:function(a){$("#syntax").val(a.getSyntax());$("#status .path").text(c.normalizePath(a.getPath()));!a.isNew()&&("xquery"==a.getSyntax()||"html"==a.getSyntax()||"xml"==a.getSyntax())?($("#status a").attr("href",a.getExternalLink()),
$("#status a").css("visibility","visible")):$("#status a").css("visibility","hidden")},showResultsPanel:function(){b.show(r,!0);i.resize(!0)},toggleResultsPanel:function(){b.toggle(r);i.resize(!0)},prepareResultsPanel:function(a,b){var c=document.getElementById("results-iframe");$("#results-body").parent().children(":not(.resize-handle)").detach().appendTo(".panel-"+a);"html"==$("#serialization-mode").val()?($(c).show(),$("#serialization-mode").attr("disabled","disabled").val("html"),b&&i.runQuery()):
$("#results-iframe").hide()},switchResultsPanel:function(){var a="south"===r?"east":"south";i.prepareResultsPanel(a,!0);b.hide(r);r=a;"south"===r?$(".layout-switcher").attr("src","resources/images/layouts_split.png"):$(".layout-switcher").attr("src","resources/images/layouts_split_vertical.png");i.showResultsPanel()},initStatus:function(a){$("#splash-status").text(a)},git:{branch:function(a){console.info("git.branch");i.login.isAdmin&&$.ajax({type:"GET",url:"modules/git.xql",data:{target:a.root,"git-command":"branch"},
dataType:"json",success:function(b){b=b.stdout?$.isArray(b.stdout.line)?b.stdout.line:[b.stdout.line]:[];a.gitBranch=$.map(b,function(b,c){var d=b.split(" ").pop();/^\*/.test(b)&&(a.gitCurrentBranch=d,a.gitCurrentBranchIndex=c);return d});$("#toolbar-current-branch").text(a.gitCurrentBranch);$("#menu-git-active").text(a.gitCurrentBranch);$("#menu-git-working-dir").text(a.workingDir)},error:s})},command:function(b,c,d,e){i.login.isAdmin&&$.ajax({type:"GET",url:"modules/git.xql",data:{target:b.root,
"git-command":c,"git-option":d},dataType:"json",success:function(b){"function"==typeof e&&e(b);a.updateStatus("");a.clearErrors();i.showResultsPanel();q=n=1;var c=document.getElementById("results-iframe");$(c).show();c.contentWindow.document.open("text/html","replace");c.contentWindow.document.write(JSON.stringify(b));c.contentWindow.document.close()},error:s})}},findFiles:function(){var b=a.getActiveDocument();d.findProject(b.getBasePath(),function(c){eXide.find.Files.open(b,c,function(b){a.updateStatus("");
a.clearErrors();q=n=1;var c=document.getElementById("results-iframe");$(c).show();eXide.app.showResultsPanel();c.contentWindow.document.open("text/html","replace");c.contentWindow.document.write("<html><body><p>Searching ...</p></body></html>");c.contentWindow.document.close();c.src="modules/search.xql?"+b})})},liveReload:function(){var b=a.getActiveDocument();d.findProject(b.getBasePath(),function(a){if(null!=a&&($.log("live reload: %s %s",a.liveReload,a.abbrev),a.liveReload)){var b=a.url.replace(/\/{2,}/,
"/");a.win=window.open(eXide.configuration.context+b+"/",a.abbrev);a.win&&!a.win.closed?a.win.location.reload():$.log("app window not found: %s",a.abbrev)}})},toggleLiveReload:function(){var b=a.getActiveDocument();d.findProject(b.getBasePath(),function(a){a&&(a.liveReload=!a.liveReload,$("#menu-deploy-live span").attr("class",a.liveReload?"fa fa-check-square-o":"fa fa-square-o"),a.liveReload&&(!a.win||a.win.closed)&&i.openApp(!0))})},initGUI:function(e){c.supportsHtml5Storage&&localStorage.getItem("eXide.firstTime")&&
(r=localStorage["eXide.layout.resultPanel"]||"south");b=new i.Layout(a);"south"==r?b.hide("east"):b.hide("south");i.prepareResultsPanel(r);$("#open-dialog").dialog({appendTo:"#layout-container",title:"Open file",modal:!1,autoOpen:!1,height:480,width:600,open:function(){f.init()},resize:function(){f.resize()}});$("#login-dialog").dialog({appendTo:"#layout-container",title:"Login",modal:!0,autoOpen:!1,buttons:[{text:"Login",click:function(){var b=$('#login-form input[name="user"]').val(),c=$('#login-form input[name="password"]').val(),
b={user:b,password:c};$('#login-form input[name="duration"]').is(":checked")&&(b.duration="P14D");$.ajax({url:"login",type:"POST",data:b,dataType:"json",success:function(b){if(b.user){i.login=b;$.log("Logged in as %o. Is dba: %s",b,i.login.isAdmin);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+i.login.user+". ");a.focus()}else{$("#login-error").text("Login failed.");$("#login-dialog input:first").focus()}},error:function(a,b,c){$("#login-error").text("Login failed. "+c);$("#login-dialog input:first").focus()}})},
icons:{primary:"fa fa-sign-in"}},{text:"Cancel",icons:{primary:"fa fa-times"},click:function(){$(this).dialog("close");a.focus()}}],open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({appendTo:"#layout-container",title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,width:350,
buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),a)}});$("#about-dialog").dialog({appendTo:"#layout-container",title:"About",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});$("#version-warning").dialog({appendTo:"#layout-container",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});$("#dialog-templates").dialog({appendTo:"#layout-container",title:"New document",
modal:!1,autoOpen:!1,height:280,width:550,dataType:"json",open:function(){$.ajax({url:"modules/get-template.xql",type:"POST",success:function(a){l=a;$("#dialog-templates .templates").hide();$("#dialog-templates .type-select").val("")}})},buttons:{Cancel:function(){$(this).dialog("close");a.focus()},Create:function(){var b=$(this).find(".type-select").val(),c=$(this).find(".templates select").val();$.log("creating new doc with mode: %s and template: %s",b,c);a.newDocumentFromTemplate(b,c);$(this).dialog("close");
a.focus()}}});$("#dialog-templates .type-select").change(function(){var a=$("#dialog-templates .templates"),b=$("select",a),c=$(this).val();b.empty();if(c=l[c]){for(var d="<option value=''>None</option>",e=0;e<c.length;e++)d+="<option value='"+c[e].name+"'>"+c[e].description+"</option>";b.html(d);a.show()}else a.hide()});c.Popup.init("#autocomplete-box",a);$(".toolbar-buttons").buttonset();var h=$("#open").button("option","icons",{primary:"fa fa-folder-open-o"});h.click(i.openDocument);e.click("#menu-file-open",
i.openDocument);h=$("#close").button("option","icons",{primary:"fa fa-times"});h.click(i.closeDocument);e.click("#menu-file-close",i.closeDocument);e.click("#menu-file-close-all",i.closeAll);h=$("#new").button("option","icons",{primary:"fa fa-file-o"});h.click(function(){i.newDocumentFromTemplate()});h=$("#new-xquery").button("option","icons",{primary:"fa fa-file-code-o"});h.click(function(){i.newDocument(null,"xquery")});e.click("#menu-file-new",i.newDocumentFromTemplate);e.click("#menu-file-new-xquery",
function(){i.newDocument(null,"xquery")});h=$("#eval").button("option","icons",{primary:"fa fa-cogs"});h.button("option","disabled",!0);h.click(function(){i.runQuery()});h=$("#run").button("option","icons",{primary:"fa fa-play"});h.click(function(){i.runAppOrQuery()});h=$("#debug").button("option","icons",{primary:"fa fa-fast-forward"});h.click(i.startDebug);h=$("#debug-actions #step-over").button("option","icons",{primary:"fa fa-fast-forward"});h.click(i.stepOver);h=$("#debug-actions #step-into").button("option",
"icons",{primary:"fa fa-fast-forward"});h.click(i.stepInto);h=$("#debug-actions #step-out").button("option","icons",{primary:"fa fa-fast-forward"});h.click(i.startDebug);h=$("#validate").button("option","icons",{primary:"fa fa-check"});h.click(i.checkQuery);h=$("#save").button("option","icons",{primary:"fa fa-save"});h.click(i.saveDocument);e.click("#menu-file-save",i.saveDocument);e.click("#menu-file-save-as",i.saveDocumentAs);e.click("#menu-file-reload",i.reloadDocument);e.click("#menu-file-download",
i.download);e.click("#menu-file-manager",i.manage);e.click("#menu-deploy-new",i.newDeployment);e.click("#menu-deploy-edit",i.deploymentSettings);e.click("#menu-deploy-live",i.toggleLiveReload);e.click("#menu-deploy-sync",i.synchronize);e.click("#menu-deploy-download",i.downloadApp);e.click("#menu-git-checkout",i.gitCheckout);e.click("#menu-git-commit",i.gitCommit);e.click("#menu-edit-undo",function(){a.editor.undo()});e.click("#menu-edit-redo",function(){a.editor.redo()});e.click("#menu-edit-find",
function(){require("ace/config").loadModule("ace/ext/searchbox",function(b){b.Search(a.editor)})});e.click("#menu-edit-find-replace",function(){require("ace/config").loadModule("ace/ext/searchbox",function(b){b.Search(a.editor,!0)})});e.click("#menu-edit-find-files",function(){i.findFiles()});e.click("#menu-edit-toggle-comment",function(){a.editor.toggleCommentLines()});e.click("#menu-edit-preferences",function(){g.show()});e.click("#menu-navigate-definition",function(){a.exec("gotoDefinition")});
e.click("#menu-navigate-modules",function(){var b=a.getActiveDocument();eXide.find.Modules.select(b.syntax)});e.click("#menu-navigate-info",function(){a.exec("showFunctionDoc")});e.click("#menu-navigate-symbol",function(){a.exec("gotoSymbol")});e.click("#menu-navigate-buffer",function(){a.selectTab()});e.click("#menu-navigate-commands",function(){i.getMenu().commandPalette()});e.click("#menu-navigate-line",function(){a.gotoLine()});e.click("#menu-navigate-history",function(){a.historyBack()});e.click("#menu-navigate-toggle-results",
function(){i.toggleResultsPanel()});e.click("#menu-navigate-reset",function(){"south"!==r&&i.switchResultsPanel();b.reset()});e.click("#menu-deploy-run",i.runAppOrQuery);e.click("#menu-help-keyboard",function(){$("#keyboard-help").dialog("open")});e.click("#menu-help-about",function(){$("#about-dialog").dialog("open")});e.click("#menu-help-documentation",function(){window.open("docs/doc.html")});$("#syntax").change(function(){a.setMode($(this).val())});a.addEventListener("activate",null,function(a){i.updateStatus(a);
d.findProject(a.getBasePath(),function(a){a?($("#toolbar-current-app").text(a.abbrev),$("#menu-deploy-active").text(a.abbrev),$("#menu-deploy-live span").attr("class",a.liveReload?"fa fa-check-square-o":"fa fa-square-o"),"true"==a.git||!0==a.git?($(".current-branch").show(),$("#menu-git").show(),eXide.app.git.branch(a)):($(".current-branch").hide(),$("#menu-git").hide())):($("#toolbar-current-app").text("unknown"),$("#menu-deploy-active").text("unknown"),$(".current-branch").hide(),$("#menu-git").hide())})});
$("#user").click(function(a){a.preventDefault();i.login?($.get("login?logout=logout"),$("#user").text("Login"),i.login=null):$("#login-dialog").dialog("open")});c.supportsFullScreen()||$("#toggle-fullscreen").hide();$("#toggle-fullscreen").click(function(a){a.preventDefault();c.requestFullScreen(document.getElementById("fullscreen"))});$(".results-container .layout-switcher").click(i.switchResultsPanel);$(".results-container .next").click(i.browseNext);$(".results-container .previous").click(i.browsePrevious);
$("#serialization-mode").change(function(){j&&i.runQuery(j)});$("#error-status").mouseover(function(){var a=this;$("#ext-status-bar").each(function(){this.innerHTML=a.innerHTML;$(this).css("display","block")})});$("#ext-status-bar,#error-status").mouseout(function(){$("#ext-status-bar").css("display","none")});$(window).blur(function(){v=!1});$(window).focus(function(){var a=!v;v=!0;a&&i.getLogin()});$("#dialog-startup").dialog({appendTo:"#layout-container",modal:!1,title:"Quick Start",autoOpen:!1,
width:400,height:300,buttons:{OK:function(){$(this).dialog("close")}}});c.supportsHtml5Storage&&(e=localStorage.getItem("eXide.firstTime"),(!e||1==e)&&$("#dialog-startup").dialog("open"))}};return i}(eXide.util);eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var c=/\n/;Constr=function(a,b,e,f){var d=e.split(c).length;this.code=e;this.editor=a.editor;this.range=b;this.type=f;b?(this.startLine=b.start.row,this.startColumn=b.start.column):(a=this.editor.getCursorPosition(),this.startLine=a.row,this.startColumn=a.column);this.endLine=this.startLine+d-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn;this.regex=/(?:\$[\w\-:_]+|\u2423)/g;0<this.startColumn&&
(this.regex.lastIndex=this.startColumn)};Constr.prototype={insert:function(){this.range&&this.editor.getSession().remove(this.range);this.editor.insert(this.code);var a=this.editor.getSelection().getSelectionLead();"$"!=this.code.substring(0,1)&&0<a.column&&this.editor.navigateLeft();"variable"!=this.type&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),b=this.editor.getSelection(),c=b.getSelectionLead();$.log("lead.row = %i startLine = %i",c.row,this.startLine);
if(c.row<this.startLine||c.row>this.endLine)return!1;for(var f=c=!1;this.currentLine<=this.endLine;){var d=a.getDisplayLine(this.currentLine);$.log("Checking line %s",d);if(d=this.regex.exec(d)){$.log("Matched %s",d[0]);b.setSelectionAnchor(this.currentLine,d.index);b.selectTo(this.currentLine,d.index+d[0].length);1===d[0].length&&a.remove(b.getRange());this.lineOffset=d.index;f=!0;break}else this.lineOffset=0,this.currentLine++;this.currentLine>this.endLine&&!c&&($.log("loop %i",this.startColumn),
this.currentLine=this.startLine,0<this.startColumn&&(this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset),c=!0)}return f}};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var c=require("ace/lib/useragent"),a=[{id:"name",name:"Name",field:"name",width:180,formatter:function(a,b,c,e,h){return h.isCollection?'<span class="collection"><img src="resources/images/folder.png"/> '+c+"</span>":c},editor:Slick.Editors.Text},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:65},{id:"group",name:"Group",field:"group",width:65},{id:"lastMod",name:"Last Modified",field:"last-modified",
width:140}],b={editable:!1,multiSelect:!1,forceSyncScrolling:!0,forceFitColumns:!0},e={editable:!0,autoEdit:!0,multiSelect:!0,autoHeight:!1,enableCellNavigation:!0,forceSyncScrolling:!0,forceFitColumns:!0};Constr=function(b,d){var g=this;this.container=$(b);this.breadcrumbs=$(".eXide-browse-breadcrumbs",d);this.loading=!1;this.search="";this.clipboard=[];this.clipboardMode="copy";this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.inEditor=!1;this.collection="/db";
this.data=[];this.grid=new Slick.Grid(this.container,this.data,a,e);var l=new Slick.RowSelectionModel;this.grid.setSelectionModel(l);l.onSelectedRangesChanged.subscribe(function(){var a=l.getSelectedRows();if(0!=g.data.length){for(var b=!0,c=0;c<a.length;c++)if(a[c]<g.data.length&&g.data[a[c]]&&!g.data[a[c]].writable){b=!1;break}g.$triggerEvent("activate",[1==a.length&&g.data[a[0]]&&!g.data[a[0]].isCollection?g.data[a[0]]:null,b])}});this.grid.onDblClick.subscribe(function(a){a=g.grid.getCellFromEvent(a);
if(g.data[a.row].isCollection){var b;b=".."==g.data[a.row].name?g.collection.replace(/\/[^\/]+$/,""):g.collection+"/"+g.data[a.row].name;g.$triggerEvent("activateCollection",[b,g.data[a.row].writable]);g.update(b,!1)}else eXide.app.openSelectedDocument()});this.grid.onKeyDown.subscribe(function(a){if(!g.inEditor)if(a.metaKey&&c.isMac||a.ctrlKey&&!c.isMac)switch(a.which){case 67:a.stopPropagation();a.preventDefault();g.copy();break;case 86:a.stopPropagation();a.preventDefault();g.paste();break;case 88:a.stopPropagation(),
a.preventDefault(),g.cut()}else if(!a.shiftKey&&!a.altKey&&!a.ctrlKey)switch(a.which){case 13:a.stopPropagation();a.preventDefault();a=l.getSelectedRows();if(1==a.length)if(g.data[a[0]].isCollection){var b;b=".."==g.data[a[0]].name?g.collection.replace(/\/[^\/]+$/,""):g.collection+"/"+g.data[a[0]].name;g.$triggerEvent("activateCollection",[b,g.data[a[0]].writable]);g.update(b,!1)}else eXide.app.openSelectedDocument();break;case 8:a.stopPropagation();a.preventDefault();a=g.collection.lastIndexOf("/");
0<a&&"/db"!=g.collection&&(b=g.collection.substring(0,a),a=g.grid.getActiveCell(),g.$triggerEvent("activateCollection",[b,g.data[a.row].writable]),g.update(b,!1));break;case 34:a.stopPropagation();a.preventDefault();a=g.grid.getActiveCell();b=-1;a.row+10<g.data.length?b=a.row+10:a.row+1!=g.data.length&&(b=g.data.length-1);-1!=b&&g.goto(b);break;case 33:a.stopPropagation();a.preventDefault();a=g.grid.getActiveCell();0<a.row&&g.goto(10<a.row?a.row-10:0);break;case 36:a.stopPropagation();a.preventDefault();
g.goto(0);break;case 35:a.stopPropagation();a.preventDefault();g.goto(g.data.length-1);break;case 46:g.deleteResource();break;case 27:g.search="";break;case 38:case 40:break;default:g.search+=String.fromCharCode(a.which);g.searchTimeout&&(clearTimeout(g.searchTimeout),g.searchTimeout=void 0);b=RegExp("^"+g.search,"i");a=g.grid.getActiveCell();for(a=a.row;a<g.data.length;a++)if(g.data[a]&&b.test(g.data[a].name)){g.goto(a);break}g.searchTimeout=setTimeout(function(){g.search=""},2E3)}});this.grid.onBeforeEditCell.subscribe(function(a,
b){g.inEditor=!0;g.oldValue=g.data[b.row].name});this.grid.onBeforeCellEditorDestroy.subscribe(function(){g.inEditor=!1});this.grid.onCellChange.subscribe(function(a,b){g.oldValue&&$.getJSON("modules/collections.xql",{target:g.data[b.row].name,rename:g.oldValue,root:g.collection},function(a){g.reload();g.data[b.row]&&g.data[b.row].isCollection&&g.$triggerEvent("activateCollection",[g.data[b.row].name]);"fail"==a.status&&eXide.util.Dialog.warning("Rename Error",a.message)})});this.grid.onViewportChanged.subscribe(function(){var a=
g.grid.getViewport();g.load(a.top,a.bottom)});$("#resource-properties-dialog").dialog({title:"Resource/collection properties",modal:!0,autoOpen:!1,height:380,width:460,buttons:{Cancel:function(){$(this).dialog("close")},Apply:function(){var a=this,b=g.grid.getSelectionModel().getSelectedRows();if(0!=b.length){for(var c=[],d=0;d<b.length;d++)c.push(g.collection+"/"+g.data[b[d]].name);b=$("form",a).serialize();b=b+"&"+$.param({"modify[]":c});$.getJSON("modules/collections.xql",b,function(){$(a).dialog("close");
g.reload()})}}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.setCollection=function(a){this.collection=a;this.updateBreadcrumbs()};Constr.prototype.updateBreadcrumbs=function(){this.breadcrumbs.empty();for(var a=this,b=this.collection.split("/"),c=$("<span>/</span>"),e="/",h=0;h<b.length;h++){var j=b[h];j&&0<j.length&&(e+=j+"/",j=$('<a href="#">').append(j),j.data("collection",e),c.append(j).append("/"),j.click(function(b){b.preventDefault();a.update($(this).data("collection"),
!1)}))}this.breadcrumbs.html(c)};Constr.prototype.setMode=function(a){this.mode=a;"manage"==a?this.grid.setOptions(e):this.grid.setOptions(b)};Constr.prototype.resize=function(){console.log("Resizing canvas...");var a=$(".eXide-browse-main").height();$(".eXide-browse-resources").height(a);this.grid.resizeCanvas();this.grid.focus()};Constr.prototype.update=function(a,b){if(b||a!==this.collection)$.log("Opening resources for %s",a),this.grid.gotoCell(0,0),this.setCollection(a),this.data.length=0,this.grid.setSelectedRows([]),
this.grid.resetActiveCell(),this.grid.setActiveCell(0,1),this.grid.invalidate(),this.grid.onViewportChanged.notify(),this.grid.focus(),this.search=""};Constr.prototype.load=function(a,b){if(!this.loading&&(!this.data[a]||!(b>=this.data.length||this.data[b]))){var c=this;this.loading=!0;b+=20;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:b},function(e){c.loading=!1;for(var h=a;h<=b;h++)c.grid.invalidateRow(h);if(e&&e.items){c.data.length=e.total;for(h=0;h<e.items.length;h++)c.data[a+
h]=e.items[h]}else c.data.length=0;c.grid.updateRowCount();c.grid.render();0==a&&(c.grid.resetActiveCell(),c.grid.setActiveCell(0,1),c.grid.focus())})}};Constr.prototype.hasSelection=function(){var a=this.grid.getSelectionModel().getSelectedRows();return a&&0<a.length};Constr.prototype.getSelected=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0==a.length)return null;for(var b=[],c=0;c<a.length;c++)b.push(this.collection+"/"+this.data[a[c]].name);return b};Constr.prototype.createCollection=
function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',function(){$("#eXide-browse-spinner").show();$.getJSON("modules/collections.xql",{create:$("#eXide-browse-collection-name").val(),collection:a.collection},function(b){$("#eXide-browse-spinner").hide();"fail"==b.status?eXide.util.Dialog.warning("Create Collection Error",b.message):a.reload()})})};
Constr.prototype.deleteCollection=function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$("#eXide-browse-spinner").show();$.getJSON("modules/collections.xql",{remove:a.collection},function(b){$("#eXide-browse-spinner").hide();"fail"==b.status?eXide.util.Dialog.warning("Delete Collection Error",b.message):a.reload()})})};Constr.prototype.deleteResource=function(){var a=this.grid.getSelectionModel().getSelectedRows();
if(0!=a.length){for(var b=[],c=0;c<a.length;c++)b.push(this.data[a[c]].key);var e=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",function(){$("#eXide-browse-spinner").show();$.getJSON("modules/collections.xql",{remove:b,root:e.collection},function(a){$("#eXide-browse-spinner").hide();e.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Resource Error",a.message)})})}};Constr.prototype.properties=function(){var a=this.grid.getSelectionModel().getSelectedRows();
if(0!=a.length){for(var b=[],c=0;c<a.length;c++)".."!=this.data[a[c]].name&&b.push(this.collection+"/"+this.data[a[c]].name);0<b.length&&($("#resource-properties-content").load("modules/collections.xql",{properties:b}),$("#resource-properties-dialog").dialog("open"))}};Constr.prototype.cut=function(){this.clipboardMode="move";this.copy()};Constr.prototype.copy=function(){var a=this.grid.getSelectionModel().getSelectedRows();this.clipboard=[];for(var b=0;b<a.length;b++){var c=this.data[a[b]].name;
"/"!=c.substr(0,1)&&(c=this.collection+"/"+c);this.clipboard.push(c)}$.log("Clipboard: %o",this.clipboard)};Constr.prototype.paste=function(){var a=this;$.log("Copying resources %o to %s",this.clipboard,this.collection);var b={root:this.collection};b[this.clipboardMode]=this.clipboard;$.getJSON("modules/collections.xql",b,function(b){$.log(b.status);"fail"==b.status?eXide.util.Dialog.warning("Delete Resource Error",b.message):a.reload()})};Constr.prototype.goto=function(a){this.grid.gotoCell(0,0);
this.grid.setSelectedRows([]);this.grid.resetActiveCell();this.grid.setActiveCell(a,1);this.grid.invalidate();this.grid.onViewportChanged.notify();this.grid.scrollRowToTop(a);this.grid.focus()};Constr.prototype.focus=function(){this.container.find(".grid-canvas").focus()};Constr.prototype.reload=function(){this.grid.invalidate();this.data.length=0;this.update(this.collection,!0);eXide.app.syncDirectory(this.collection)};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){function c(a,b,c){var f=$("#progress-all",a);$(b).fileupload({sequentialUploads:!0,autoUpload:!1,dataType:"json",dropZone:c}).on("fileuploadadd",function(b,c){$("#file_upload thead").show();$("#eXide-browse-spinner").show();c.context=$("#files");for(var e=0;e<c.files.length;e++){var f=c.context.find("tr").length,j=c.files[e];if("."!=j.name){var m=null,n=j.name;j.webkitRelativePath?n=j.webkitRelativePath:j.relativePath&&(n=j.relativePath+n);j.path=n;200==f?$('<tr><td colspan="3">Only 200 files are shown. More follow...</td></tr>').appendTo(c.context):
200>f&&(m=$('<tr data-name="'+n+'"/>'),m.append($("<td/>").text(j.name)),m.append($("<td/>").text(j.size)),m.append($('<td class="file_upload_progress"><div class="ui-progressbar-value" style="width: 0%;"></div></td>')),m.appendTo(c.context));c.formData={path:n,collection:$('input[name="collection"]',a).val(),deploy:$("input[name='deploy']",a).is(":checked")};c.submit().done(function(){m&&m.remove()})}}}).on("fileuploadprogress",function(b,c){$.each(c.files,function(b,d){var e=parseInt(100*(c.loaded/
c.total),10);$("tr[data-name='"+d.path+"']",a).find(".ui-progressbar-value").css("width",e+"%")})}).on("fileuploadprogressall",function(a,b){var c=parseInt(100*(b.loaded/b.total),10);f.css("width",c+"%").text(c+"%");100<=c&&($("#files").empty(),$("#eXide-browse-spinner").hide())}).on("fileuploaddone",function(){f.empty().css("width","0%")}).on("fileuploadfail",function(a,b){console.log("error: ",b)})}Constr=function(a){this.container=a;this.events={done:[]};$("#progress-all").empty().css("width",
"0%");c(a,"#file_upload",$(".file_upload_drop"));var b=document.createElement("input");"webkitdirectory"in b||"mozdirectory"in b||"odirectory"in b||"msdirectory"in b||"directory"in b?c(a,"#dir_upload",null):$("#dir_upload").parent().hide();var e=this;$("#eXide-browse-upload-done").button({icons:{primary:"fa fa-times"}}).click(function(){$("#files").empty();e.$triggerEvent("done",[])})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.update=function(a){$.log("Upload collection: %s",
a);$("#files").empty();$("#file_upload thead").hide();$('input[name="collection"]',this.container).val(a)};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){function c(a,b,c,f,d){var g=document.createElement("button");g.title=b;g.id="eXide-browse-toolbar-"+c;g.tabindex=f;b=document.createElement("span");b.className="fa fa-lg fa-"+d;g.appendChild(b);a.append(g);return g}Constr=function(a){var b=this;this.mode="open";var e=$(".eXide-browse-toolbar",a),f=c(e,"Reload","reload",1,"refresh");$(f).click(function(){b.resources.reload(!0)});this.btnCreateCollection=c(e,"Create Collection","create",3,"folder-o");$(this.btnCreateCollection).click(function(a){a.preventDefault();
b.resources.createCollection()});this.btnUpload=c(e,"Upload Files","upload",4,"cloud-upload");$(this.btnUpload).click(function(c){c.preventDefault();$(".eXide-browse-resources",a).hide();$(".eXide-browse-upload",a).show();b.$triggerEvent("upload-open",[!0])});this.btnDeleteResource=c(e,"Delete","delete-resource",5,"trash-o");$(this.btnDeleteResource).click(function(a){a.preventDefault();b.deleteSelected()});this.btnProperties=c(e,"Properties","properties",10,"info");$(this.btnProperties).click(function(a){a.preventDefault();
b.resources.properties()});f=c(e,"Open Selected","open",6,"edit");$(f).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});this.btnCopy=c(e,"Copy","copy",7,"copy");this.btnCut=c(e,"Cut","cut",8,"cut");this.btnPaste=c(e,"Paste","paste",9,"paste");this.selection=$(".eXide-browse-form input",a);this.container=a;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",a),a);this.upload=new eXide.browse.Upload($(".eXide-browse-upload",a).hide());this.resources.addEventListener("activate",
this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onActivateCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",a).show();$(".eXide-browse-upload",a).hide();b.$triggerEvent("upload-open",[!1]);this.reload()});$(this.btnCopy).click(function(a){a.preventDefault();b.resources.copy()});$(this.btnCut).click(function(a){a.preventDefault();b.resources.cut()});$(this.btnPaste).click(function(a){a.preventDefault();b.resources.paste()});
$("#eXide-browse-spinner").hide()};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){this.resources.resize();this.resources.reload()};Constr.prototype.reload=function(a,b){if(a){$(".eXide-browse-toolbar button",this.container).hide();for(var c=0;c<a.length;c++)$("#eXide-browse-toolbar-"+a[c]).show()}b&&(this.mode=b);this.resources.setMode(b);this.resources.reload();"save"===this.mode?$(".eXide-browse-form",this.container).show().focus():$(".eXide-browse-form",this.container).hide();
this.resize();$(this.selection).val("")};Constr.prototype.resize=function(){};Constr.prototype.deleteSelected=function(){this.resources.getSelected();this.resources.deleteResource()};Constr.prototype.getSelection=function(){var a=$(this.selection).val();return null==a||""==a?null:{name:a,path:this.resources.collection+"/"+a,writable:!0}};Constr.prototype.changeToCollection=function(a){this.resources.update(a,!0)};Constr.prototype.onActivateResource=function(a,b){a?$(this.selection).val(a.name):$(this.selection).val("");
"open"!=this.mode&&b?($(this.btnDeleteResource).css("display",""),$(this.btnProperties).css("display","")):($(this.btnDeleteResource).css("display","none"),$(this.btnProperties).css("display","none"))};Constr.prototype.onActivateCollection=function(a,b){$.log("Activate collection: %s %s",a,this.mode);switch(this.mode){case "open":case "save":$(".eXide-browse-toolbar button",this.container).hide();$(this.btnCreateCollection).css("display","");break;default:b?($(this.btnCreateCollection).css("display",
""),$(this.btnUpload).css("display",""),$(this.btnCut).css("display",""),$(this.btnPaste).css("display",""),$(this.btnDeleteResource).css("display","")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display","none"),$(this.btnCut).css("display","none"),$(this.btnPaste).css("display","none"),$(this.btnDeleteResource).css("display","none"))}this.upload.update(a,b)};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){var c={backwards:!1,wrap:!0,caseSensitive:!1,wholeWord:!1,regExp:!1};Constr=function(a,b){var c=this;c.input=$(a);c.input.hide();c.input.keyup(function(a){switch(a.which){case 27:case 13:a.preventDefault();c.input.hide();c.editor.focus();break;case 40:a.preventDefault();c.editor.findNext();break;case 38:a.preventDefault();c.editor.findPrevious();break;case 71:if(a.metaKey||a.ctrlKey){a.preventDefault();c.editor.findNext();break}default:c.onChange()}});c.editor=
b};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;this.input.val("");this.input.show().focus()};Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);var a=this.input.val();this.editor.find(a,c,!0);this.input.focus()};return Constr}();eXide.namespace("eXide.find.SearchReplace");
eXide.find.SearchReplace=function(){Constr=function(c){var a=this;a.editor=c;a.needleSet=!1;a.lastSearch=null;a.container=$("#find-replace-dialog");a.container.dialog({modal:!1,autoOpen:!1,height:300,width:600,buttons:{Close:function(){$(this).dialog("close");a.editor.focus()},Replace:function(){a.replace(!1)},"Replace All":function(){a.replace(!0)},"Find Next":function(){a.find(1)},"Find Previous":function(){a.find(-1)}}})};Constr.prototype.open=function(){this.container.dialog("open");this.container.find("input[name='search']").focus()};
Constr.prototype.find=function(c){var a=this.container.find("input[name='search']").val();$.log("Searching for %s",a);a&&0<a.length&&(null!=this.lastSearch&&this.lastSearch==a?-1==c?this.editor.findPrevious():this.editor.findNext():(this.editor.find(a,this.getOptions(),!0),this.needleSet=!0),this.editor.focus())};Constr.prototype.replace=function(c){var a=this.container.find("input[name='search']").val();if(a&&0<a.length&&(this.needleSet||(this.editor.find(a,this.getOptions(),!0),this.needleSet=!0),
(a=this.container.find("input[name='replace']").val())&&0<a.length))c?this.editor.replaceAll(a):(this.editor.replace(a),this.editor.findNext())};Constr.prototype.getOptions=function(){var c=this.container.find("input[name='case']").is(":checked"),a=this.container.find("input[name = 'regex']").is(":checked");return{wrap:!0,caseSensitive:c,regExp:a}};return Constr}();eXide.namespace("eXide.find.Files");
eXide.find.Files=function(){var c;$(document).ready(function(){c=$("#find-dialog");c.dialog({title:"Search binary files",modal:!1,autoOpen:!1,height:400,width:600})});return{open:function(a,b,e){b?(c.find("input.project").get().disabled=!1,c.find("input.project").val(b.root),c.find(".project-path").text(b.abbrev)):c.find("input.project").get().disabled=!0;c.find("input[name='collection']").val(a.getBasePath());c.dialog("option","buttons",{Close:function(){$(this).dialog("close");self.editor.focus()},
Search:function(){var a=c.find("form").serialize();e(a);$(this).dialog("close")}});c.dialog("open")}}}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var c={open:[],"import":[]},a=[{id:"prefix",name:"Prefix",field:"prefix",sortable:!0,resizable:!0,maxWidth:100,minWidth:60},{id:"uri",name:"URI",field:"uri",sortable:!0,resizable:!0,minWidth:100},{id:"at",name:"Location",field:"at",sortable:!0,resizable:!0}],b={editable:!1,multiSelect:!1,forceFitColumns:!0},e=[],f;$(document).ready(function(){$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init});f=new Slick.Grid("#module-list",
e,a,b);var c=new Slick.RowSelectionModel({selectActiveRow:!0});f.setSelectionModel(c);f.onDblClick.subscribe(function(a){a=f.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[e[a.row]])});f.onSort.subscribe(function(a,b){$.log("sorting on field: %s",b.sortCol.field);e.sort(function(a,c){var d=b.sortCol.field,e=a[d],d=c[d],e=(e==d?0:e>d?1:-1)*(b.sortAsc?1:-1);return 0!=e?e:0});f.invalidate();f.render()})});return{select:function(a){var b={Open:function(){eXide.find.Modules.trigger("open");
$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}};"xquery"==a&&(b.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",b);$("#select-module-dialog").dialog("open")},trigger:function(a){var b=f.getSelectionModel().getSelectedRows();1==b.length&&eXide.find.Modules.$triggerEvent(a,[e[b[0]]])},$init:function(){f.resizeCanvas();f.invalidate();e.length=0;$.getJSON("modules/find.xql",function(a){e.length=
a.length;for(var b=0;b<a.length;b++)e[b]=a[b];f.updateRowCount();f.render();f.setActiveCell(0,0);f.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(a,b,e){(a=c[a])&&a.push({obj:b,callback:e})},$triggerEvent:function(a,b){var e=c[a];if(e)for(var f=0;f<e.length;f++)e[f].callback.apply(e[f].obj,b)}}}();eXide.namespace("eXide.edit.Visitor");eXide.edit.Visitor=function(){Constr=function(){};Constr.prototype.visit=function(c,a){if(c){var b=c.name,e=!1;"function"===typeof this[b]&&(e=!0===this[b](c)?!0:!1);e||this.visitChildren(c,a)}};Constr.prototype.visitChildren=function(c,a){if(c)for(var b=0;b<c.children.length;b++){var e=c.children[b];if(void 0!==a&&"function"===typeof a[e.name])a[e.name](e);else this.visit(e,a)}};return Constr}();eXide.namespace("eXide.edit.XQueryUtils");
eXide.edit.XQueryUtils=function(){return{findNode:function(c,a){if(!0===eXide.edit.XQueryUtils.inRange(c.pos,a,!1)){for(var b in c.children){var e=eXide.edit.XQueryUtils.findNode(c.children[b],a);if(null!==e)return e}return c}return null},findNodeForRange:function(c,a,b){var e=c.pos;if(!0===eXide.edit.XQueryUtils.inRange(e,a)&&!0===eXide.edit.XQueryUtils.inRange(e,b)){for(var f in c.children)if(e=eXide.edit.XQueryUtils.findNode(c.children[f],a,b),null!==e)return e;return c}return null},inRange:function(c,
a,b){if(c&&c.sl<=a.line&&a.line<=c.el){if(c.sl<a.line&&a.line<c.el)return!0;if(c.sl==a.line&&a.line<c.el)return c.sc<=a.col;if(c.sl==a.line&&c.el===a.line)return c.sc<=a.col&&a.col<=c.ec+(b?1:0);if(c.sl<a.line&&c.el===a.line)return a.col<=c.ec+(b?1:0)}},samePosition:function(c,a){return c.sl==a.sl&&c.sc==a.sc&&c.el==a.el&&c.ec==a.ec},findNext:function(c,a){for(var b=c.getParent.children,e=0;e<b.length;e++)if(b[e]==c)for(var f=e+1;f<b.length;f++)if(b[f].name==a)return b[f];return null},findChild:function(c,
a){for(var b=c.children,e=0;e<b.length;e++)if(b[e].name==a)return b[e];return null},findSibling:function(c,a){for(var b=c.getParent.children,e=0;e<b.length;e++)if(b[e].name==a)return b[e];return null},findSiblings:function(c,a){for(var b=c.getParent.children,e=[],f=0;f<b.length;f++)b[f]!=c&&b[f].name==a&&e.push(b[f]);return e},findAncestor:function(c,a){if(a instanceof Array)for(;null!==c;){if(-1<$.inArray(c.name,a))return c;c=c.getParent}else for(;null!==c;){if(c.name==a)return c;c=c.getParent}return null},
findVariableContext:function(c,a){for(var b=c.getParent;null!==b;){if(("FLWORExpr"===b.name||"FunctionDecl"===b.name)&&null!==eXide.edit.XQueryUtils.findVarDecl(b,a))return b;if("FunctionDecl"===b.name)break;b=b.getParent}return null},getValue:function(c){var a="";if(c.value)a=c.value;else for(var b=0;b<c.children.length;b++)a+=eXide.edit.XQueryUtils.getValue(c.children[b]);return a},findVarDecl:function(c,a){for(var b=(new eXide.edit.VariableReferences(a,c)).getReferences(),e=0;e<b.length;e++)if(b[e].getParent&&
"LetBinding"===b[e].getParent.name||"ForBinding"===b[e].getParent.name||"Param"===b[e].getParent.name)return b[e];return null},getPath:function(c){for(var a=[c.name],c=c.getParent;c;)a.push(c.name),c=c.getParent;return a.reverse().join("/")}}}();eXide.namespace("eXide.edit.VariableReferences");
eXide.edit.VariableReferences=function(){require("ace/range");Constr=function(c,a){this.variable=c;this.references=[];this.visit(a)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.VarName=function(c){eXide.edit.XQueryUtils.getValue(c)==this.variable&&this.references.push(c)};Constr.prototype.Param=function(c){for(var a=0;a<c.children.length;a++)c.children[a].value===this.variable&&this.references.push(c.children[a])};Constr.prototype.getReferences=function(){return this.references};
return Constr}();eXide.namespace("eXide.edit.InScopeVariables");
eXide.edit.InScopeVariables=function(){require("ace/range");Constr=function(c,a){this.node=a;this.stack=[];this.variables=null;this.visit(c)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.FLWORExpr=function(c){var a=this.stack.length;this.visitChildren(c);this.stack.length=a;return!0};Constr.prototype.VarName=function(c){if(c==this.node)return this.variables=this.deepCopy(this.stack),!0;if("ForBinding"===c.getParent.name||"LetBinding"===c.getParent.name)c=eXide.edit.XQueryUtils.getValue(c),
this.stack.push(c)};Constr.prototype.VarRef=function(c){return c==this.node?(this.variables=this.deepCopy(this.stack),!0):!1};Constr.prototype.VarDecl=function(c){var a=this;this.visitChildren(c,{VarName:function(b){b=eXide.edit.XQueryUtils.getValue(b);a.stack.push(b);return!0},VarValue:function(){return!0}});return!0};Constr.prototype.FunctionDecl=function(c){var a=this.deepCopy(this.stack);this.visitChildren(c);this.stack=a;return!0};Constr.prototype.Param=function(c){var a=this;this.visitChildren(c,
{EQName:function(b){a.stack.push(b.value)}});return!0};Constr.prototype.deepCopy=function(c){for(var a=[],b=0;b<c.length;b++)a.push(c[b]);return a};Constr.prototype.getStack=function(){return this.variables};return Constr}();eXide.namespace("eXide.edit.FunctionParameters");
eXide.edit.FunctionParameters=function(){require("ace/range");Constr=function(c){this.parameters=[];this.visit(c)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.Argument=function(c){var a;this.visitChildren(c,{VarName:function(b){a=eXide.edit.XQueryUtils.getValue(b);return!1}});a?this.parameters.push(a):this.parameters.push("argument"+this.parameters.length);return!0};Constr.prototype.getParameters=function(){return this.parameters};return Constr}();eXide.namespace("eXide.edit.FunctionCalls");
eXide.edit.FunctionCalls=function(){require("ace/range");Constr=function(c,a,b){this.name=c;this.arity=a;this.references=[];this.declaration=null;this.visit(b)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.FunctionCall=function(c){if(c.arity!==this.arity)return!1;c.children[0].value===this.name&&this.references.push(c.children[0]);return!1};Constr.prototype.FunctionDecl=function(c){var a=this;parseInt(c.arity)===this.arity&&this.visitChildren(c,{EQName:function(b){if(b.value===
a.name)return a.declaration=b,!0}});return!1};Constr.prototype.getReferences=function(){return this.references};return Constr}();
eXide.edit.ModuleInfo=function(){Constr=function(c){this.moduleNamespace=this.modulePrefix=null;this.annotations={};this.functions=[];this.prolog=null;this.visit(c)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.isModule=function(){return null!==this.moduleNamespace};Constr.prototype.hasTests=function(){for(var c in this.annotations)if(/test\:/.test(c))return!0;return!1};Constr.prototype.Prolog=function(c){this.prolog=c};Constr.prototype.FunctionDecl=function(c){this.functions.push(c)};
Constr.prototype.ModuleDecl=function(c){var a=this;this.visitChildren(c,{NCName:function(b){a.modulePrefix=eXide.edit.XQueryUtils.getValue(b);return!1},URILiteral:function(b){a.moduleNamespace=b.value;return!1}});return!1};Constr.prototype.Annotation=function(c){var a=this;this.visitChildren(c,{EQName:function(b){a.annotations[b.value]=1;return!1}});return!1};return Constr}();eXide.namespace("eXide.edit.XQueryQuickFix");
eXide.edit.XQueryQuickFix=function(){function c(a,b,c,l){var a=eXide.edit.XQueryUtils.findNode(c.ast,{line:l.row,col:l.column+1}).getParent,h=eXide.edit.XQueryUtils.findNext(a,"Separator"),a=l.pos.sl,c=l.pos.sc,j=h?h.pos.el:l.pos.el,l=h?h.pos.ec:l.pos.ec,h=b.editor.getSession().getLine(j),l=l==h.length?new e(a,c,j+1,0):new e(a,c,j,l);b.editor.getSession().remove(l)}var a=require("ace/snippets").snippetManager,b=[{regex:/Call to undeclared function/,getResolutions:function(a,b,c,e,h){var j=/undeclared function:\s+([\w\d\-_]+:[\w\d\-_]+)$/.exec(e.text);
if(2===j.length){var m=j[1].split(":")[0];return[{action:'Create function "'+j[1]+'"',resolve:function(a,b,c){a=new eXide.edit.PrologAdder(b,c);b=(new eXide.edit.FunctionParameters(h.getParent)).getParameters();a.addFunction(j[1],b)}},{action:'Import module "'+m+'"',resolve:function(a,b,c){(new eXide.edit.PrologAdder(b,c)).importModule(m)}}]}return null}},{regex:/unused namespace prefix/,getResolutions:function(a,b,e,l,h){a="Remove namespace declaration";eXide.edit.XQueryUtils.findAncestor(h,"ModuleImport")&&
(a="Remove module import");return[{resolve:c,action:a}]}},{regex:/No namespace defined/,getResolutions:function(a,b,c,e,h){var j=/for prefix (\w+)/.exec(e.text);if(2===j.length){if(h&&"FunctionCall"===h.getParent.name)return[{resolve:function(a,b,c){a.parent.validator.setEnabled(!1);(new eXide.edit.PrologAdder(b,c)).importModule(j[1]);a.xqlint(c);a.autocomplete(c);a.parent.validator.setEnabled(!0)},action:'Import module "'+j[1]+'"'}];if(h&&("EQName"===h.name||"ElementTest"===h.getParent.name||"OptionDecl"===
h.getParent.name))return[{resolve:function(a,b,c){a.parent.validator.setEnabled(!1);(new eXide.edit.PrologAdder(b,c)).declareNamespace(j[1]);a.xqlint(c);a.autocomplete(c);a.parent.validator.setEnabled(!0)},action:'Declare namespace "'+j[1]+'"'}]}}},{regex:/variable.*not set/,getResolutions:function(b,c,e,l,h){if("VarName"===h.getParent.name)return[{resolve:function(a,b,c){(new eXide.edit.PrologAdder(b,c)).declareVariable(h.value)},action:'Declare global variable "'+h.value+'"'},{resolve:function(b,
c){var d,e=eXide.edit.XQueryUtils.findAncestor(h,["IntermediateClause","InitialClause","ReturnClause"]);if(e)d="let \\$"+h.value+" := ${1:()}";else{e=eXide.edit.XQueryUtils.findAncestor(h,"StatementsAndOptionalExpr");e=eXide.edit.XQueryUtils.findChild(e,"Expr");if(!e){eXide.util.error("Extract variable: unable to determine context. Giving up.");return}d="let \\$"+h.value+" := ${1:()}\nreturn"}b.parent.validator.setEnabled(!1);$.log("extract variable: context: %o",e);c.editor.gotoLine(e.pos.sl+1,e.pos.sc);
c.editor.insert("\n");c.editor.gotoLine(e.pos.sl+1,e.pos.sc);a.insertSnippet(c.editor,d);c.editor.focus();b.parent.validator.setEnabled(!0)},action:"Create let statement"}]}}];require("lib/Compiler");var e=require("ace/range").Range;return{getResolutions:function(a,c,e,l){for(var h=[],j=0;j<b.length;j++)if(b[j].regex.test(l.text)){var m=eXide.edit.XQueryUtils.findNode(e.ast,{line:l.row,col:l.column+1}),m=b[j].getResolutions(a,c,e,l,m);if(null!=m)for(var n=0;n<m.length;n++)h.push(m[n])}return h}}}();
eXide.namespace("eXide.edit.PrologAdder");
eXide.edit.PrologAdder=function(){require("ace/range");var c=require("ace/snippets").snippetManager;Constr=function(a,b){this.editor=a;this.doc=b;this.program=this.prolog=null;this.visit(b.ast)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.Prolog=function(a){this.prolog=a};Constr.prototype.VersionDecl=function(a){this.decl=a};Constr.prototype.getInsertionPoint=function(a){var b=0;if(a){if(a=eXide.edit.XQueryUtils.findAncestor(a,"FunctionDecl"))b=a.pos.el}else 0<this.prolog.children.length?
b=this.prolog.pos.el:this.decl&&(b=this.decl.pos.el);return b};Constr.prototype.addFunction=function(a,b){this.prepareFunction();var e="declare function "+a+"(";if(b)for(var f=0;f<b.length;f++)0<f&&(e+=", "),e+="$${"+(f+1)+":"+b[f]+"}";e+=") {\n\t${"+(arguments.length+1)+":()}\n};";c.insertSnippet(this.editor.editor,e)};Constr.prototype.createFunction=function(a,b,c){for(var c=this.prepareFunction(c),f="declare function (",d=0;d<a.length;d++)0<d&&(f+=", "),f+="$"+a[d];this.editor.editor.insert(f+
(") {\n\t"+b+"\n};"));this.editor.editor.gotoLine(c,17)};Constr.prototype.prepareFunction=function(a){a=a||this.getInsertionPoint();this.editor.editor.gotoLine(a+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(a+3,0);return a+3};Constr.prototype.importModule=function(a,b,e){var a=-1<a.indexOf(":")?a.substring(0,a.indexOf(":")):a,f=0;this.decl&&(f=this.decl.pos.el);for(var d=0;d<this.prolog.children.length;d++)if("Import"===this.prolog.children[d].name){f=
this.prolog.children[d].pos.sl-1;break}f=0>f?0:f;this.editor.editor.gotoLine(f+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(f+3,0);b?(b="import module namespace "+a+'="'+b+'"',b=e?b+(' at "'+e+'";'):b+";"):b="import module namespace "+a+'="${1}";';c.insertSnippet(this.editor.editor,b);this.editor.editor.gotoLine(f+3,26+a.length)};Constr.prototype.declareNamespace=function(a){var b=0;this.decl&&(b=this.decl.pos.el);for(var e=0;e<this.prolog.children.length;e++)if("NamespaceDecl"===
this.prolog.children[e].name){b=this.prolog.children[e].pos.sl-1;break}b=0>b?0:b;this.editor.editor.gotoLine(b+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(b+3,0);c.insertSnippet(this.editor.editor,"declare namespace "+a+'="${1}";')};Constr.prototype.declareVariable=function(a){$.log("prolog: %o",this.prolog);for(var b=-1,e=0;e<this.prolog.children.length;e++)if("AnnotatedDecl"===this.prolog.children[e].name){b=this.prolog.children[e].pos.sl-
1;break}0>b&&(b=0<this.prolog.children.length?this.prolog.children[this.prolog.children.length-1].pos.el:this.decl?this.decl.pos.el:0);$.log("Inserting at %d",b);this.editor.editor.gotoLine(b+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(b+3,0);c.insertSnippet(this.editor.editor,"declare variable \\$"+a+" := ${1:expression};")};return Constr}();eXide.namespace("eXide.util.Snippets");
eXide.util.Snippets=function(){var c=require("ace/snippets").snippetManager,a={};return{init:function(b){a[b]||(a[b]=[],$.ajax({url:"templates/"+b+".snippets",dataType:"text",success:function(e){e=c.parseSnippetFile(e);c.register(e,b);a[b]=e}}))},getTemplates:function(b,c){for(var f=a[b.getSyntax()],d=[],g=0;g<f.length;g++)(!c||0==f[g].name.indexOf(c))&&d.push({TYPE:eXide.edit.Document.TYPE_TEMPLATE,name:f[g].name,template:f[g].content});return d},reload:function(b,e){var f=c.parseSnippetFile(e);
$.log("Replacing snippets %o for mode %s",f,b);c.register(f,b);a[b]=f}}}();eXide.namespace("eXide.edit.SnippetModeHelper");eXide.edit.SnippetModeHelper=function(){Constr=function(c){this.parent=c;this.editor=this.parent.editor};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(c){var a=c.getText(),c=c.getName().replace(/\.snippets/,"");eXide.util.Snippets.reload(c,a)};return Constr}();eXide.namespace("eXide.app.FlexboxSplitter");
eXide.app.FlexboxSplitter=function(){Constr=function(c,a,b,e,f){var d=this;d.resizable=$(a);d.isHorizontal="west"==b||"east"==b;d.min=e;var g=d.resizable.find(".resize-handle"),a=g.find("span"),l=d.resizable.parents(".layout");d.prevSize=f;var h=!1;g.on("mousedown",function(a){a.preventDefault();var f=d.isHorizontal?a.pageX:a.pageY;h=!1;d.$triggerEvent("beforeResize");l.on("mousemove",function(a){var g=d.isHorizontal?a.pageX:a.pageY,a=f-g;h=0!==a;f=g;if(h){if(d.isHorizontal){if(g=d.resizable.width(),
a="west"==b?-a:a,g<e&&0<a||g+a>=e)d.resizable.width(g+a),d.resizable.css("min-width",g+a+"px")}else g=d.resizable.height(),g-(1-a)>=e&&d.resizable.height(g-(1-a));c.resize()}});$(document).on("mouseup",function(){l.off("mousemove");$(document).off("mouseup");d.$triggerEvent("afterResize")})});a.click(function(){var a="west"==b||"east"==b?d.resizable.width():d.resizable.height();10==a?("west"==b||"east"==b?(d.resizable.width(d.prevSize),d.resizable.css("min-width",d.prevSize+"px")):d.resizable.height(d.prevSize),
g.removeClass("minimized"),g.addClass("resize-handle"),d.resizable.find(">*:not(.minimized)").show()):(d.prevSize=a,"west"==b||"east"==b?(d.resizable.width(10),d.resizable.css("min-width","10px")):d.resizable.height(10),g.addClass("minimized"),g.removeClass("resize-handle"),d.resizable.find(">*:not(.minimized)").hide());c.resize()})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.getSize=function(){return this.resizable.is(":hidden")?0:this.isHorizontal?this.resizable.width():
this.resizable.height()};Constr.prototype.setSize=function(c,a){a&&(this.prevSize=a);if(0===c)this.hide();else{c>this.min&&c<this.min&&(c=this.min);this.isHorizontal?(this.resizable.width(c),this.resizable.css("min-width",c+"px")):this.resizable.height(c);if(10===c){var b=this.resizable.find(".resize-handle");b.addClass("minimized");this.resizable.find(">*:not(.minimized)").hide();b.removeClass("resize-handle")}else this.prevSize=c,this.resizable.find(">*:not(.minimized)").show(),this.resizable.find(".minimized").addClass("resize-handle").removeClass("minimized");
this.resizable.is(":hidden")&&this.resizable.show()}};Constr.prototype.hide=function(){this.prevSize=this.isHorizontal?this.resizable.width():this.resizable.height();this.resizable.hide()};Constr.prototype.show=function(c){this.resizable.is(":hidden")?(this.resizable.show(),this.setSize(this.prevSize)):c&&10==this.getSize()&&this.setSize(this.prevSize)};Constr.prototype.toggle=function(){this.resizable.is(":hidden")?this.show():this.hide()};return Constr}();eXide.namespace("eXide.app.Layout");
eXide.app.Layout=function(){var c={west:{size:200,preferred:200},south:{size:10,preferred:200},east:{size:0,preferred:380}},a=function(a){this.editor=a;this.regions={west:new eXide.app.FlexboxSplitter(this,".panel-west","west",100,200),south:new eXide.app.FlexboxSplitter(this,".panel-south","south",100,200),east:new eXide.app.FlexboxSplitter(this,".panel-east","east",360,380)};this.regions.east.addEventListener("beforeResize",eXide.app.beforeResize);this.regions.east.addEventListener("afterResize",
eXide.app.afterResize)};a.prototype.resize=function(){eXide.app.resize(!0)};a.prototype.hide=function(a){this.regions[a].hide()};a.prototype.show=function(a,c){this.regions[a].show(c)};a.prototype.toggle=function(a){this.regions[a].toggle()};a.prototype.saveState=function(){localStorage["eXide.layout.south"]=this.regions.south.getSize();localStorage["eXide.layout.west"]=this.regions.west.getSize();localStorage["eXide.layout.east"]=this.regions.east.getSize()};a.prototype.restoreState=function(a){if(a)for(var c in this.regions)this.regions[c].setSize(parseInt(localStorage["eXide.layout."+
c]));else this.reset()};a.prototype.reset=function(){for(var a in this.regions){var e=c[a];this.regions[a].setSize(e.size,e.preferred)}eXide.app.afterResize()};return a}();eXide.namespace("eXide.util.DnD");
eXide.util.DnD=function(){var c=function(a){var b=this,a=$(a);a.on("dragenter",function(b){b.stopPropagation();b.preventDefault();a.addClass("dropping")});a.on("dragover",function(a){a.stopPropagation();a.preventDefault()});a.on("dragleave",function(b){b.stopPropagation();b.preventDefault();a.removeClass("dropping")});a.on("drop",function(c){c.stopPropagation();c.preventDefault();a.removeClass("dropping");c.originalEvent.dataTransfer&&c.originalEvent.dataTransfer.files&&b.$triggerEvent("drop",[c.originalEvent.dataTransfer.files])})};
eXide.util.oop.inherit(c,eXide.events.Sender);return c}();